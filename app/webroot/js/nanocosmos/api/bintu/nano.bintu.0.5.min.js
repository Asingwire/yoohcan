/**
 * @license
 * Copyright (c) 2016 nanocosmos IT GmbH. All rights reserved.
 * http://www.nanocosmos.de
 * Bintu Release Version 0.4
 */

/**
 * @file Bintu Streaming API Classes.
 * @author nanocosmos IT GmbH
 * @copyright (c) 2016 nanocosmos IT GmbH. All rights reserved.
 * @version 0.4
 */

(function(){"use strict";function t(){this.state=this.setState(t.STATE.ALL),this.tags=[]}var e=function(t,e,r,n){if(this.apiKey=null,this.apiUrl=null,this.isWebrtcStream=!!r,this.isTranscodedStream=!!n,!(t.length>0&&("string"==typeof t||t instanceof String)))throw new Error("The param 'apiKey' must be of type 'string' and also may not be empty string.");if(this.apiKey=t,!(e.length>0&&("string"==typeof e||e instanceof String)))throw new Error("The param 'apiUrl' must be of type 'string' and also may not be empty string.");this.apiUrl=e},r=e.prototype,n=this,o=n.Bintu,s=function(t,e,r,n,o,s){var i=this;i.method=t||"GET",i.url=e||"http://localhost:8088",i.header=r||{},i.async=n||!0,i.onSuccess=o||function(t){},i.onError=s||function(t){},i.Send=function(t){var e=new XMLHttpRequest;e.open(i.method,i.url,i.async);for(var r in i.header)e.setRequestHeader(r,i.header[r]);if(e.onreadystatechange=function(){4==e.readyState&&200==e.status?"function"==typeof i.onSuccess&&i.onSuccess(e):4==e.readyState&&200!==e.status&&"function"==typeof i.onError&&i.onError({error:"onstatuserror",request:e})},e.onabort=function(){"function"==typeof i.onError&&i.onError({error:"onabort",request:e})},e.onerror=function(){"function"==typeof i.onError&&i.onError({error:"onerror",request:e})},e.ontimeout=function(){"function"==typeof i.onError&&i.onError({error:"ontimeout",request:e})},"undefined"!=typeof t){if("string"==typeof t)try{t=JSON.parse(t)}catch(r){t=null,"function"==typeof i.onError&&i.onError({error:"invalid json string",request:e})}if("object"==typeof t)try{t=JSON.stringify(t),e.send(t)}catch(t){"function"==typeof i.onError&&i.onError({error:"invalid json object",request:e})}}else e.send()}};r.validateApiKey=function(t,e){if(!this.apiUrl)return"function"==typeof e&&e({error:"no api url set",request:{responseText:"no response error"}});if(!this.apiKey)return"function"==typeof e&&e({error:"no api key set",request:{responseText:"no response error"}});var r=new s("POST",this.apiUrl+"/apikey");r.header={Accept:"application/json","Content-Type":"application/json"},r.onSuccess=t,r.onError=e,r.Send({apikey:this.apiKey})},r.createStream=function(t,e,r){if(!this.apiUrl)return"function"==typeof r&&r({error:"no api url set",request:{responseText:"no response error"}});if(!this.apiKey)return"function"==typeof r&&r({error:"no api key set",request:{responseText:"no response error"}});var n=new s("POST",this.apiUrl+"/stream");n.header={Accept:"application/json","Content-Type":"application/json","X-BINTU-APIKEY":this.apiKey},n.onSuccess=e,n.onError=r;var o={webrtc:this.isWebrtcStream,transcoding:this.isTranscodedStream};"object"==typeof t&&"function"==typeof t.push&&t.length>0&&("string"==typeof t[0]||t[0]instanceof String)&&(o.tags=t),n.Send(o)},r.getStream=function(t,e,r){if(!this.apiUrl)return"function"==typeof r&&r({error:"no api url set",request:{responseText:"no response error"}});if(!this.apiKey)return"function"==typeof r&&r({error:"no api key set",request:{responseText:"no response error"}});var n=new s("GET",this.apiUrl+"/stream/"+t);n.header={Accept:"application/json","Content-Type":"application/json","X-BINTU-APIKEY":this.apiKey},n.onSuccess=e,n.onError=r,n.Send()},r.getStreams=function(e,r,n){if(!this.apiUrl)return"function"==typeof n&&n({error:"no api url set",request:{responseText:"no response error"}});if(!this.apiKey)return"function"==typeof n&&n({error:"no api key set",request:{responseText:"no response error"}});var o=this.apiUrl+"/stream";e instanceof t&&(o+=e.getQueryString());var i=new s("GET",o);i.header={Accept:"application/json","Content-Type":"application/json","X-BINTU-APIKEY":this.apiKey},i.onSuccess=r,i.onError=n,i.Send()},r.tagStream=function(t,e,r,n){if(!this.apiUrl)return"function"==typeof n&&n({error:"no api url set",request:{responseText:"no response error"}});if(!this.apiKey)return"function"==typeof n&&n({error:"no api key set",request:{responseText:"no response error"}});if(!t)return"function"==typeof n&&n({error:"no stream id set"});var o=new s("PUT",this.apiUrl+"/stream/"+t+"/tag");o.header={Accept:"application/json","Content-Type":"application/json","X-BINTU-APIKEY":this.apiKey},o.onSuccess=r,o.onError=n,"object"==typeof e&&"function"==typeof e.push&&e.length>0&&("string"==typeof e[0]||e[0]instanceof String)?o.Send({tags:e}):o.Send()},e.noConflict=function(){return n.Bintu=o,e},n.Bintu=e,r=t.prototype,t.STATE=Object.create({LIVE:"live",CREATED:"created",ENDED:"ended",ALL:null}),r.setState=function(e){var r=void 0;for(var n in t.STATE)t.STATE[n]===e&&(r=t.STATE[n]);if("undefined"==typeof r)throw new Error("The param 'state' must be of type 'BintuStreamFilter.STATE'");return this.state=r,this},r.addTag=function(t){if(!(t.length>0&&("string"==typeof t||t instanceof String)))throw new Error("The param 'tag' must be of type 'string' and also may not be empty string.");return this.tags.push(t),this.tags=this._reduceDuplicates(this.tags),this},r.addTags=function(t){if("object"!=typeof t||"function"!=typeof t.push||!(0===t.length||t.length>0&&("string"==typeof t[0]||t[0]instanceof String)))throw new Error("The param 'tags' must be of type 'string array'");return this.tags=this.tags.concat(t),this.tags=this._reduceDuplicates(this.tags),this},r.getQueryString=function(){var t="";if("object"==typeof this.tags&&"function"==typeof this.tags.push&&this.tags.length>0)for(var e=0;e<this.tags.length;e+=1)"string"==typeof this.tags[e]&&(t+=0==e?"?":"&",t+="tags[]="+this.tags[e]);return"string"==typeof this.state&&this.state.length>0&&(t+=t.indexOf("?")===-1?"?":"&",t+="state="+this.state),t},r._reduceDuplicates=function(t){if("object"!=typeof t||"function"!=typeof t.push||!(0===t.length||t.length>0&&("string"==typeof t[0]||t[0]instanceof String)))throw new Error("The param 'tags' must be of type 'string array'");return t.reduce(function(t,e){return t.indexOf(e)<0&&t.push(e),t},[])},n.BintuStreamFilter=t}).call(this),define("nano.bintu",function(){});