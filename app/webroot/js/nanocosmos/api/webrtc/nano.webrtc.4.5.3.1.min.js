/**
 * @license almond 0.3.3 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/almond/LICENSE
 */

/**
 * @license NanoTools 2.1.0 
 * Copyright (c) 2016-2017 nanocosmos IT GmbH. All rights reserved.
 * http://www.nanocosmos.de
 * debug/log
 * RtcStats
 */

/*!
 * EventEmitter v4.2.11 - git.io/ee
 * Unlicense - http://unlicense.org/
 * Oliver Caldwell - http://oli.me.uk/
 * @preserve
 */

// (c) 2014-2017 nanocosmos gmbh, All rights reserved

/*
 *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree.
 */

/**
     * @file WebRTC Public API Class.
     * @author nanocosmos IT GmbH
     * @copyright (c) 2016 nanocosmos IT GmbH. All rights reserved.
     * @version 4.4.2
     */

/**
 * @license WebRTC Release Version 4.4
 * Copyright (c) 2016 nanocosmos IT GmbH. All rights reserved.
 * http://www.nanocosmos.de
 */

function mergeConstraints(e,t){if(!e||!t)return e||t;var i=e;for(var n in t)i[n]=t[n];return i}function iceCandidateType(e){return e.split(" ")[7]}function formatTypePreference(e){if("chrome"===adapter.browserDetails.browser)switch(e){case 0:return"TURN/TLS";case 1:return"TURN/TCP";case 2:return"TURN/UDP"}else if("firefox"===adapter.browserDetails.browser)switch(e){case 0:return"TURN/TCP";case 5:return"TURN/UDP"}return""}function maybeSetOpusOptions(e,t){return"true"===t.opusStereo?e=setCodecParam(e,"opus/48000","stereo","1"):"false"===t.opusStereo&&(e=removeCodecParam(e,"opus/48000","stereo")),"true"===t.opusFec?e=setCodecParam(e,"opus/48000","useinbandfec","1"):"false"===t.opusFec&&(e=removeCodecParam(e,"opus/48000","useinbandfec")),"true"===t.opusDtx?e=setCodecParam(e,"opus/48000","usedtx","1"):"false"===t.opusDtx&&(e=removeCodecParam(e,"opus/48000","usedtx")),t.opusMaxPbr&&(e=setCodecParam(e,"opus/48000","maxplaybackrate",t.opusMaxPbr)),e}function maybeSetAudioSendBitRate(e,t){return t.audioSendBitrate?(trace("Prefer audio send bitrate: "+t.audioSendBitrate),preferBitRate(e,t.audioSendBitrate,"audio")):e}function maybeSetAudioReceiveBitRate(e,t){return t.audioRecvBitrate?(trace("Prefer audio receive bitrate: "+t.audioRecvBitrate),preferBitRate(e,t.audioRecvBitrate,"audio")):e}function maybeSetVideoSendBitRate(e,t){return t.videoSendBitrate?(trace("Prefer video send bitrate: "+t.videoSendBitrate),preferBitRate(e,t.videoSendBitrate,"video")):e}function maybeSetVideoReceiveBitRate(e,t){return t.videoRecvBitrate?(trace("Prefer video receive bitrate: "+t.videoRecvBitrate),preferBitRate(e,t.videoRecvBitrate,"video")):e}function preferBitRate(e,t,i){var n=e.split("\r\n"),r=findLine(n,"m=",i);if(null===r)return trace("Failed to add bandwidth line to sdp, as no m-line found"),e;var a=findLineInRange(n,r+1,-1,"m=");null===a&&(a=n.length);var s=findLineInRange(n,r+1,a,"c=");if(null===s)return trace("Failed to add bandwidth line to sdp, as no c-line found"),e;var o=findLineInRange(n,s+1,a,"b=AS");o&&n.splice(o,1);var d="b=AS:"+t;return n.splice(s+1,0,d),e=n.join("\r\n")}function maybeSetVideoSendInitialBitRate(e,t){var i=t.videoSendInitialBitrate;if(!i)return e;var n=i,r=t.videoSendBitrate;r&&(i>r&&(trace("Clamping initial bitrate to max bitrate of "+r+" kbps."),i=r,t.videoSendInitialBitrate=i),n=r);var a=e.split("\r\n"),s=findLine(a,"m=","video");if(null===s)return trace("Failed to find video m-line"),e;var o=t.videoRecvCodec;return e=setCodecParam(e,o,"x-google-min-bitrate",t.videoSendInitialBitrate.toString()),e=setCodecParam(e,o,"x-google-max-bitrate",n.toString())}function removePayloadTypeFromMline(e,t){e=e.split(" ");for(var i=0;i<e.length;++i)e[i]===t.toString()&&e.splice(i,1);return e.join(" ")}function removeCodecByName(e,t){var i=findLine(e,"a=rtpmap",t);if(null===i)return e;var n=getCodecPayloadTypeFromLine(e[i]);e.splice(i,1);var r=findLine(e,"m=","video");return null===r?e:(e[r]=removePayloadTypeFromMline(e[r],n),e)}function removeCodecByPayloadType(e,t){var i=findLine(e,"a=rtpmap",t.toString());if(null===i)return e;e.splice(i,1);var n=findLine(e,"m=","video");return null===n?e:(e[n]=removePayloadTypeFromMline(e[n],t),e)}function maybeRemoveVideoFec(e,t){if("false"!==t.videoFec)return e;var i=e.split("\r\n"),n=findLine(i,"a=rtpmap","red");if(null===n)return e;var r=getCodecPayloadTypeFromLine(i[n]);if(i=removeCodecByPayloadType(i,r),i=removeCodecByName(i,"ulpfec"),n=findLine(i,"a=fmtp",r.toString()),null===n)return e;var a=parseFmtpLine(i[n]),s=a.pt;return null===s?e:(i.splice(n,1),i=removeCodecByPayloadType(i,s),i.join("\r\n"))}function maybePreferAudioSendCodec(e,t){return maybePreferCodec(e,"audio","send",t.audioSendCodec)}function maybePreferAudioReceiveCodec(e,t){return maybePreferCodec(e,"audio","receive",t.audioRecvCodec)}function maybePreferVideoSendCodec(e,t){return maybePreferCodec(e,"video","send",t.videoSendCodec)}function maybePreferVideoReceiveCodec(e,t){return maybePreferCodec(e,"video","receive",t.videoRecvCodec)}function maybePreferCodec(e,t,i,n){var r=t+" "+i+" codec";if(!n)return trace("No preference on "+r+"."),e;trace("Prefer "+r+": "+n);var a=e.split("\r\n"),s=findLine(a,"m=",t);if(null===s)return e;var o=getCodecPayloadType(a,n);return o&&(a[s]=setDefaultCodec(a[s],o)),e=a.join("\r\n")}function setCodecParam(e,t,i,n){var r=e.split("\r\n"),a=findFmtpLine(r,t),s={};if(null===a){var o=findLine(r,"a=rtpmap",t);if(null===o)return e;var d=getCodecPayloadTypeFromLine(r[o]);s.pt=d.toString(),s.params={},s.params[i]=n,r.splice(o+1,0,writeFmtpLine(s))}else s=parseFmtpLine(r[a]),s.params[i]=n,r[a]=writeFmtpLine(s);return e=r.join("\r\n")}function removeCodecParam(e,t,i){var n=e.split("\r\n"),r=findFmtpLine(n,t);if(null===r)return e;var a=parseFmtpLine(n[r]);delete a.params[i];var s=writeFmtpLine(a);return null===s?n.splice(r,1):n[r]=s,e=n.join("\r\n")}function parseFmtpLine(e){var t={},i=e.indexOf(" "),n=e.substring(i+1).split("; "),r=new RegExp("a=fmtp:(\\d+)"),a=e.match(r);if(!a||2!==a.length)return null;t.pt=a[1];for(var s={},o=0;o<n.length;++o){var d=n[o].split("=");2===d.length&&(s[d[0]]=d[1])}return t.params=s,t}function writeFmtpLine(e){if(!e.hasOwnProperty("pt")||!e.hasOwnProperty("params"))return null;var t=e.pt,i=e.params,n=[],r=0;for(var a in i)n[r]=a+"="+i[a],++r;return 0===r?null:"a=fmtp:"+t.toString()+" "+n.join("; ")}function findFmtpLine(e,t){var i=getCodecPayloadType(e,t);return i?findLine(e,"a=fmtp:"+i.toString()):null}function findLine(e,t,i){return findLineInRange(e,0,-1,t,i)}function findLineInRange(e,t,i,n,r){for(var a=i!==-1?i:e.length,s=t;s<a;++s)if(0===e[s].indexOf(n)&&(!r||e[s].toLowerCase().indexOf(r.toLowerCase())!==-1))return s;return null}function getCodecPayloadType(e,t){var i=findLine(e,"a=rtpmap",t);return i?getCodecPayloadTypeFromLine(e[i]):null}function getCodecPayloadTypeFromLine(e){var t=new RegExp("a=rtpmap:(\\d+) [a-zA-Z0-9-]+\\/\\d+"),i=e.match(t);return i&&2===i.length?i[1]:null}function setDefaultCodec(e,t){var i=e.split(" "),n=i.slice(0,3);n.push(t);for(var r=3;r<i.length;r++)i[r]!==t&&n.push(i[r]);return n.join(" ")}var requirejs,require,define;!function(e){function t(e,t){return g.call(e,t)}function i(e,t){var i,n,r,a,s,o,d,c,u,h,l,m,p=t&&t.split("/"),f=_.map,v=f&&f["*"]||{};if(e){for(e=e.split("/"),s=e.length-1,_.nodeIdCompat&&C.test(e[s])&&(e[s]=e[s].replace(C,"")),"."===e[0].charAt(0)&&p&&(m=p.slice(0,p.length-1),e=m.concat(e)),u=0;u<e.length;u++)if(l=e[u],"."===l)e.splice(u,1),u-=1;else if(".."===l){if(0===u||1===u&&".."===e[2]||".."===e[u-1])continue;u>0&&(e.splice(u-1,2),u-=2)}e=e.join("/")}if((p||v)&&f){for(i=e.split("/"),u=i.length;u>0;u-=1){if(n=i.slice(0,u).join("/"),p)for(h=p.length;h>0;h-=1)if(r=f[p.slice(0,h).join("/")],r&&(r=r[n])){a=r,o=u;break}if(a)break;!d&&v&&v[n]&&(d=v[n],c=u)}!a&&d&&(a=d,o=c),a&&(i.splice(0,o,a),e=i.join("/"))}return e}function n(t,i){return function(){var n=S.call(arguments,0);return"string"!=typeof n[0]&&1===n.length&&n.push(null),h.apply(e,n.concat([t,i]))}}function r(e){return function(t){return i(t,e)}}function a(e){return function(t){p[e]=t}}function s(i){if(t(f,i)){var n=f[i];delete f[i],v[i]=!0,u.apply(e,n)}if(!t(p,i)&&!t(v,i))throw new Error("No "+i);return p[i]}function o(e){var t,i=e?e.indexOf("!"):-1;return i>-1&&(t=e.substring(0,i),e=e.substring(i+1,e.length)),[t,e]}function d(e){return e?o(e):[]}function c(e){return function(){return _&&_.config&&_.config[e]||{}}}var u,h,l,m,p={},f={},_={},v={},g=Object.prototype.hasOwnProperty,S=[].slice,C=/\.js$/;l=function(e,t){var n,a=o(e),d=a[0],c=t[1];return e=a[1],d&&(d=i(d,c),n=s(d)),d?e=n&&n.normalize?n.normalize(e,r(c)):i(e,c):(e=i(e,c),a=o(e),d=a[0],e=a[1],d&&(n=s(d))),{f:d?d+"!"+e:e,n:e,pr:d,p:n}},m={require:function(e){return n(e)},exports:function(e){var t=p[e];return"undefined"!=typeof t?t:p[e]={}},module:function(e){return{id:e,uri:"",exports:p[e],config:c(e)}}},u=function(i,r,o,c){var u,h,_,g,S,C,b,E=[],R=typeof o;if(c=c||i,C=d(c),"undefined"===R||"function"===R){for(r=!r.length&&o.length?["require","exports","module"]:r,S=0;S<r.length;S+=1)if(g=l(r[S],C),h=g.f,"require"===h)E[S]=m.require(i);else if("exports"===h)E[S]=m.exports(i),b=!0;else if("module"===h)u=E[S]=m.module(i);else if(t(p,h)||t(f,h)||t(v,h))E[S]=s(h);else{if(!g.p)throw new Error(i+" missing "+h);g.p.load(g.n,n(c,!0),a(h),{}),E[S]=p[h]}_=o?o.apply(p[i],E):void 0,i&&(u&&u.exports!==e&&u.exports!==p[i]?p[i]=u.exports:_===e&&b||(p[i]=_))}else i&&(p[i]=o)},requirejs=require=h=function(t,i,n,r,a){if("string"==typeof t)return m[t]?m[t](i):s(l(t,d(i)).f);if(!t.splice){if(_=t,_.deps&&h(_.deps,_.callback),!i)return;i.splice?(t=i,i=n,n=null):t=e}return i=i||function(){},"function"==typeof n&&(n=r,r=a),r?u(e,t,i,n):setTimeout(function(){u(e,t,i,n)},4),h},h.config=function(e){return h(e)},requirejs._defined=p,define=function(e,i,n){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");i.splice||(n=i,i=[]),t(p,e)||t(f,e)||(f[e]=[e,i,n])},define.amd={jQuery:!0}}(),define("../../../../node_modules/almond/almond",function(){}),define("nano.tools",[],function(){"use strict";var e=Math.floor,t=Math.random,i={browserInfo:void 0,HTTPParams:void 0,logTime:!0,debugLevel:0,debugCount:0,debugMax:30,ELEMENT_DEBUG:"debug",ELEMENT_MESSAGES:"messages",ELEMENT_ERRORS:"errors"};return i.parseJSON=function(e,t,n){if("object"==typeof e)return e;try{return JSON.parse(e,t)}catch(t){i.error_("Error:"+t+" parsing from json: "+e,n)}},i.stringifyJSON=function(e,t,n,r){if(i.isString(e))return e;try{return JSON.stringify(e,t,n)}catch(t){i.error_("Error:"+t+" stringifying to json: "+e,r)}},i.getHTTPParam=function(e){var t,n;if(!i.HTTPParams){i.HTTPParams=[];var r=document.location.search.substr(1,document.location.search.length),a=document.location.href;if(""===r&&a.indexOf("?")!==-1&&(r=a.slice(a.indexOf("?")+1)),""!==r)for(r=r.split("&"),t=0,n=r.length;t<n;t++){var s=r[t].split("="),o=s[0],d=s.length>1?s[1]:"";i.HTTPParams[unescape(o)]=unescape(d)}}return i.HTTPParams[e]},i.encodeURIComponent=function(e,t){return i.isString(e)?decodeURIComponent(e)===e?encodeURIComponent(e):e:void i.error_("Error: could not uri encode: "+e+"(must be of type string)",t)},i.getElement=function(e){var t=document.getElementById(e);return t?t:(i.debug_("DOM element not found "+e),{value:void 0,checked:void 0,enabled:void 0,textContent:void 0,options:{length:0},style:{},innerHTML:"",src:"",classList:"",click:function(){return null},show:function(){return null},hide:function(){return null},removeChild:function(){return null}})},i.elementExists=function(e){return!!document.getElementById(e)},i.showElement=function(e,t){var n=i.getElement(e);n&&(t||"undefined"==typeof t?n.style.display="block":n.style.display="none")},i.disableElement=function(e){var t=i.getElement(e);t&&(i.getElement(e).disabled=!0)},i.print_=function(e){i._log(e,"messages")},i.success_=function(e){i._log(e,"messages","green")},i.warning_=function(e){i._log(e,"messages","orange")},i.error_=function(e,t){t||(t=1),i._log(e,i.ELEMENT_MESSAGES,"red"),i._log(e,i.ELEMENT_ERRORS,"red",t)},i.debug_=function(e){0!==i.debugLevel&&i._log(e,i.ELEMENT_DEBUG)},i._log=function(e,t,n,r){i.isObject(e)&&(e=i.stringifyJSON(e,null," "));var a="";if(i.logTime&&window.performance){var s=(window.performance.now()/1e3).toFixed(3);a=s+": "}switch(n){case"green":e="Success: "+e;break;case"orange":e="Warning: "+e;break;case"red":e="Error: "+e;break;default:n=""}n?console.log("%c"+e,"color:"+n):t===i.ELEMENT_DEBUG&&console.log(e);var o=document.getElementById(t);if(o&&(t===i.ELEMENT_DEBUG&&i.debugCount>i.debugMax&&(o.removeChild(o.firstChild),i.debugCount++),o.innerHTML+="<span"+(n?' style="color:'+n+';">':">")+e+"</span><br>"),r>1)throw new Error(e)},i.contains=function(e,t){var i,n,r=0,a=0,s=t.split("*");for(i=0,n=s.length;i<n;i++)0!==s[i].length&&(a++,e.indexOf(s[i])!==-1&&r++);return r===a},i.isBool=function(e){return e===!0||e===!1},i.isIntString=function(e){return i.isString(e)&&i.isInt(Number(e))},i.isNumber=function(e){return Number(e)===e&&isFinite(e)},i.isInt=function(e){return e===Number(e)&&e%1===0},i.isUint=function(e){return e===Number(e)&&e%1===0&&e>=0},i.isString=function(e){return"string"==typeof e||e instanceof String},i.isFunction=function(e){return"function"==typeof e},i.isObject=function(e){return!!e&&e.constructor!==Array&&("object"==typeof e||e instanceof Object)},i.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},i.showRtcStats=function(e,t,n){var r,a,s="";if(n)for(r=0;r<n.length;++r){var o=n[r],d=o.id;if(d){var c=!1;if(c=!0,"bweforvideo"===d&&(c=!0),d.length>19&&"ssrc"===d.substring(0,4)&&d.indexOf("send")!==-1&&(c=!0),d.indexOf("Certific")===-1&&d.indexOf("LibjingleSession")===-1||(c=!1),c&&o.names){i.debug_("RTC-Stat-ID: "+d+"\n");var u=o.names();if(u){for(s+="["+d+"]: ",a=0;a<u.length;++a){var h=u[a];if(!h.indexOf("Certific")!==-1)try{h.length>4&&"goog"===h.substring(0,4)&&(h=h.substring(4)),s+=h,s+=" : ",s+=o.stat(u[a])+" "}catch(e){i.debug_(e)}}s+="\r\n"}}}else s+=t}if(s.length>1){i.debug_("RTC Status:"+s);var l=document.getElementById(e);if(l){var m=s.replace(/\r?\n|\r/g,"<br>").replace(/\[/g,"<b>[").replace(/\]/g,"]</b>");l.innerHTML="<b>RTC Status:</b><br>"+m}}},i.showRtmpStats=function(e,t){var n=document.getElementById(e);n?(i.debug_("RTMP Status: "+t),n.innerHTML="<b>RTMP Stats:</b><br>"+t):i.success_(event.text+": "+t)},i.getRandomUint=function(n){return n=i.isUint(n)?n:10,e(t()*n)},i.getRandomString=function(e,t){var n,r,a,s,o="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",d="0123456789abcdefghijklmnopqrstuvwxyz",c="0123456789";switch(e){case 0:s=c;break;case 1:s=d;break;case 2:s=o;break;default:s=d}var u="",h=i.getRandomUint;for(n=0,r=i.isUint(t)?t:6,a=s.length;n<r;n++)u+=s[h(a)];return u},i.shortenText=function(e,t){t=i.isUint(t)?t:40;var n=e.replace(/[\n\r]/g,"");return n.length>t?n.substr(0,t)+" ...":n},i.findIndexInObjectArray=function(e,t){var i,n;for(i=0,n=e.length;i<n;i++)if(e[i][t])return i;return null},i.findValueInObjectArray=function(e,t){var n=i.findIndexInObjectArray(e,t);return n?e[n][t]:null},i.createBrowserInfo=function(){var e,t,n="Unknown",r="";if(screen.width){var a=screen.width?screen.width:"",s=screen.height?screen.height:"";r+=""+a+" x "+s}var o,d,c,u=navigator.appVersion,h=navigator.userAgent,l=navigator.appName,m=""+parseFloat(u),p=parseInt(u,10);(d=h.indexOf("Opera"))!==-1&&(l="Opera",m=h.substring(d+6),(d=h.indexOf("Version"))!==-1&&(m=h.substring(d+8))),(d=h.indexOf("OPR/"))!==-1?(l="Opera",m=h.substring(d+4)):(d=h.indexOf("MSIE"))!==-1?(l="Microsoft Internet Explorer",m=h.substring(d+5)):"Netscape"===l&&(d=h.indexOf("Trident/"))!==-1?(l="Microsoft Internet Explorer",m=h.substring(d+8),(d=h.indexOf("rv:"))!==-1&&(m=h.substring(d+3))):"Netscape"===l&&(d=h.indexOf("Edge/"))!==-1?(l="Microsoft Edge",m=h.substring(d+5)):(d=h.indexOf("Chrome"))!==-1?(l="Chrome",m=h.substring(d+7)):(d=h.indexOf("Safari"))!==-1?(l="Safari",m=h.substring(d+7),(d=h.indexOf("Version"))!==-1&&(m=h.substring(d+8)),h.indexOf("CriOS")!==-1&&(l="Chrome")):(d=h.indexOf("Firefox"))!==-1?(l="Firefox",m=h.substring(d+8)):(o=h.lastIndexOf(" ")+1)<(d=h.lastIndexOf("/"))&&(l=h.substring(o,d),m=h.substring(d+1),l.toLowerCase()===l.toUpperCase()&&(l=navigator.appName)),(c=m.indexOf(";"))!==-1&&(m=m.substring(0,c)),(c=m.indexOf(" "))!==-1&&(m=m.substring(0,c)),(c=m.indexOf(")"))!==-1&&(m=m.substring(0,c)),p=parseInt(""+m,10),isNaN(p)&&(m=""+parseFloat(u),p=parseInt(u,10));var f=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(u),_=navigator.cookieEnabled;"undefined"!=typeof navigator.cookieEnabled||_||(document.cookie="testcookie",_=document.cookie.indexOf("testcookie")!==-1);var v=n,g=[{os:"Windows 3.11",regex:/Win16/},{os:"Windows 95",regex:/(Windows 95|Win95|Windows_95)/},{os:"Windows ME",regex:/(Win 9x 4.90|Windows ME)/},{os:"Windows 98",regex:/(Windows 98|Win98)/},{os:"Windows CE",regex:/Windows CE/},{os:"Windows 2000",regex:/(Windows NT 5.0|Windows 2000)/},{os:"Windows XP",regex:/(Windows NT 5.1|Windows XP)/},{os:"Windows Server 2003",regex:/Windows NT 5.2/},{os:"Windows Vista",regex:/Windows NT 6.0/},{os:"Windows 7",regex:/(Windows 7|Windows NT 6.1)/},{os:"Windows 8.1",regex:/(Windows 8.1|Windows NT 6.3)/},{os:"Windows 8",regex:/(Windows 8|Windows NT 6.2)/},{os:"Windows NT 4.0",regex:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{os:"Windows ME",regex:/Windows ME/},{os:"Android",regex:/Android/},{os:"Open BSD",regex:/OpenBSD/},{os:"Sun OS",regex:/SunOS/},{os:"Linux",regex:/(Linux|X11)/},{os:"iOS",regex:/(iPhone|iPad|iPod)/},{os:"Mac OS X",regex:/Mac OS X/},{os:"Mac OS",regex:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{os:"QNX",regex:/QNX/},{os:"UNIX",regex:/UNIX/},{os:"BeOS",regex:/BeOS/},{os:"OS/2",regex:/OS\/2/},{os:"Search Bot",regex:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(e=0,t=g.length;e<t;++e)if(g[e].regex.test(h)){v=g[e].os;break}var S=n;switch(/Windows/.test(v)&&(S=(/Windows (.*)/.exec(v)||[])[1],v="Windows"),v){case"Mac OS X":S=(/Mac OS X (10[\.\_\d]+)/.exec(h)||[])[1];break;case"Android":S=(/Android ([\.\_\d]+)/.exec(h)||[])[1];break;case"iOS":S=/OS (\d+)_(\d+)_?(\d+)?/.exec(u)||[],S=S[1]+"."+S[2]+"."+(0|S[3])}i.browserInfo={screenSize:r,browser:l,browserVersion:m,mobile:f,os:v,osVersion:S,cookiesEnabled:_}},i.createBrowserInfo(),i}),function(){"use strict";function e(){}function t(e,t){for(var i=e.length;i--;)if(e[i].listener===t)return i;return-1}function i(e){return function(){return this[e].apply(this,arguments)}}var n=e.prototype,r=this,a=r.EventEmitter;n.getListeners=function(e){var t,i,n=this._getEvents();if(e instanceof RegExp){t={};for(i in n)n.hasOwnProperty(i)&&e.test(i)&&(t[i]=n[i])}else t=n[e]||(n[e]=[]);return t},n.flattenListeners=function(e){var t,i=[];for(t=0;t<e.length;t+=1)i.push(e[t].listener);return i},n.getListenersAsObject=function(e){var t,i=this.getListeners(e);return i instanceof Array&&(t={},t[e]=i),t||i},n.addListener=function(e,i){var n,r=this.getListenersAsObject(e),a="object"==typeof i;for(n in r)r.hasOwnProperty(n)&&t(r[n],i)===-1&&r[n].push(a?i:{listener:i,once:!1});return this},n.on=i("addListener"),n.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},n.once=i("addOnceListener"),n.defineEvent=function(e){return this.getListeners(e),this},n.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},n.removeListener=function(e,i){var n,r,a=this.getListenersAsObject(e);for(r in a)a.hasOwnProperty(r)&&(n=t(a[r],i),n!==-1&&a[r].splice(n,1));return this},n.off=i("removeListener"),n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,i){var n,r,a=e?this.removeListener:this.addListener,s=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(n=i.length;n--;)a.call(this,t,i[n]);else for(n in t)t.hasOwnProperty(n)&&(r=t[n])&&("function"==typeof r?a.call(this,n,r):s.call(this,n,r));return this},n.removeEvent=function(e){var t,i=typeof e,n=this._getEvents();if("string"===i)delete n[e];else if(e instanceof RegExp)for(t in n)n.hasOwnProperty(t)&&e.test(t)&&delete n[t];else delete this._events;return this},n.removeAllListeners=i("removeEvent"),n.emitEvent=function(e,t){var i,n,r,a,s,o=this.getListenersAsObject(e);for(a in o)if(o.hasOwnProperty(a))for(i=o[a].slice(0),r=i.length;r--;)n=i[r],n.once===!0&&this.removeListener(e,n.listener),s=n.listener.apply(this,t||[]),s===this._getOnceReturnValue()&&this.removeListener(e,n.listener);return this},n.trigger=i("emitEvent"),n.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},n.emitSimple=function(e,t,i){return this.emitEvent(e,[{name:e||"AnonymousEvent",target:i||this,data:t||{}}])},n.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},n._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},n._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return r.EventEmitter=a,e},"function"==typeof define&&define.amd?define("EventEmitter",[],function(){return e}):"object"==typeof module&&module.exports?module.exports=e:r.EventEmitter=e}.call(this),define("nano.screencapture",["nano.tools","EventEmitter"],function(e,t){"use strict";function i(e){t.call(this),this._screenCaptureName=e||"nanoScreenCapture",this._mediaType="local",this._test=!1,this._sourceId=null,this._screenConstraints="",this.width=0,this.height=0,this.maxWidth=1920,this.maxHeight=1080,this.framerate=3,this.screenCaptureAvailable=null,this._onGetSourceId=null,this._onReleaseSourceId=null;var i=this;window.addEventListener("message",function(e){if(e.origin===window.location.origin&&i._isValidType(e.data.type)&&e.data.command)if("message"===e.data.command)"isReady"===e.data.value?(i.screenCaptureAvailable=!0,n(i._screenCaptureName+" event screenCaptureAvailable / isReady ")):"isLoaded"===e.data.value?(i.screenCaptureAvailable=!0,n(i._screenCaptureName+" event screenCaptureAvailable / isLoaded")):"isReleased"===e.data.value&&(n(i._screenCaptureName+" event isReleased"),i._sourceId=null,i._onReleaseSourceId&&i._onReleaseSourceId(),r.name="ReleaseSourceId",i.emit(r.name,r));else if("error"===e.data.command){var t=i._screenCaptureName+" error: "+e.data.value;if(n(t),"PermissionDeniedError"===e.data.value){var r=i._addPayload();r.name="PermissionDenied",r.data.error="ScreenCapture (Chrome) - "+e.data.value,i.emit(r.name,r)}}else if("setSourceId"===e.data.command){var a=e.data.value;n(i._screenCaptureName+" event setSourceId"),i._setSourceId(a)}}),this.checkAlive()}var n=e.debug_,r=e.isFunction,a=i.prototype=Object.create(t.prototype);return a._mediaId=String(""),a._mediaIndex=Number(-1),a._addPayload=function(e){return e=e||{},e.data={},e.data.mediaId=this._mediaId,e.data.mediaIndex=this._mediaIndex,e.data.mediaType=this._mediaType,e},a._toWindow=function(e,t,i){n(this._screenCaptureName+" _toWindow --> { type: "+e+", command: "+t+", value: "+i+" }"),window.postMessage({type:e,command:t,value:i},"*")},a._isValidType=function(e){return e==this._screenCaptureName},a._setSourceId=function(e){"undefined"!=typeof e?this._sourceId=e:this._sourceId=null,this._onGetSourceId&&this._onGetSourceId()},a.getScreenCaptureName=function(){return this._screenCaptureName},a.isScreenCaptureAvailable=function(){return this.screenCaptureAvailable},a.checkAlive=function(){if(this._test=!0,null===this.screenCaptureAvailable){var e=this;setTimeout(function(){e._test=null,e.screenCaptureAvailable||(e.screenCaptureAvailable=!1)},500)}n(this._screenCaptureName+" alive?"),this._toWindow(this._screenCaptureName,"isAlive","")},a.getSourceId=function(e){r(e)&&(this._onGetSourceId=e,n(this._screenCaptureName+" getSourceId"),this._toWindow(this._screenCaptureName,"getSourceId",""))},a.releaseSourceId=function(e){r(e)&&(this._onReleaseSourceId=e,n(this._screenCaptureName+" releaseSourceId"),null!==this._sourceId&&this._toWindow(this._screenCaptureName,"releaseSourceId",""))},a.getScreenConstraints=function(e){var t=window.screen.width,i=window.screen.height;this.width>0&&(t=this.width),this.height>0&&(i=this.height),t>this.maxWidth&&(t=this.maxWidth),i>this.maxHeight&&(i=this.maxHeight);var n,r=this.framerate,a=null,s=null;return e.frameRate&&(a=e.frameRate.max,s=e.frameRate.min,n=e.frameRate.ideal,r=n),this._screenConstraints={audio:!1,video:{mandatory:{maxWidth:t,maxHeight:i},optional:[]}},t>0&&i>0&&(this._screenConstraints.video.optional.push({minWidth:t}),this._screenConstraints.video.optional.push({minHeight:i}),this._screenConstraints.video.optional.push({maxWidth:t}),this._screenConstraints.video.optional.push({maxHeight:i})),r>0&&(this._screenConstraints.video.optional.push({minFrameRate:s||r}),this._screenConstraints.video.optional.push({maxFrameRate:a||r})),navigator.webkitGetUserMedia?(this._screenConstraints.video.mandatory.chromeMediaSource="desktop",""==this._sourceId&&(this._sourceId=null)):this._screenConstraints.video.mediaSource="screen",this._screenConstraints.video.mandatory.chromeMediaSourceId=this._sourceId,this._screenConstraints},i}),define("nano.const",[],function(){"use strict";var e={ROLE_BROADCASTER:0,ROLE_VIEWER:1,ROLE_MONITOR:2,ROLE_MIXED:3,ROLE_CHATTER:4,ROLE_TRANSCODER:100,CHANNEL_IDLE:1,CHANNEL_SIGNED_IN:2,CHANNEL_HANDSHAKE:3,CHANNEL_CALLING:4,CHANNEL_CALL_INCOMING:5,CHANNEL_CALL_NEGOTIATING:6,CHANNEL_CALL_ACTIVE:7,CHANNEL_CALL_DROPPED:8,CHANNEL_CALL_UNSTABLE:9,CHANNEL_CALL_REJECTED:10,HANDSHAKE_IDLE:1,HANDSHAKE_CALLYOU:2,HANDSHAKE_CALLME:3,HANDSHAKE_DONE:4,STREAM_NOMEDIASTREAM:1,STREAM_ACTIVE:2,STREAM_INACTIVE:3,STREAM_ENDED:4};return e}),define("nano.localmedia",["nano.screencapture","nano.const","nano.tools","EventEmitter"],function(e,t,i,n){"use strict";function r(i,r,a,s){n.call(this),u(i)||o("LocalMedia: param mediaId must be of type string",2),c(r)||o("LocalMedia: param mediaIndex must be an integer",2),this._mediaId=i,this._mediaIndex=r,this._mediaType="local",this._useScreenCapture=!!a,this._nanoScreenCapture=new e(u(a)?a:"nanoScreenCapture"),this._useScreenCaptureOnly=!!s,this._timeoutScreenCapture=2e3,this._getDevicesWithoutSC=!1,this._nanoScreenCapture._mediaId=this._mediaId,this._nanoScreenCapture._mediaIndex=this._mediaIndex,this._devices={video:[],audio:[],listed:{video:[],audio:[]},selected:{video:!0,audio:!0},muted:{video:!1,audio:!1},constraints:{video:!0,audio:!0},stream:null,enumerated:!1,state:t.STREAM_NOMEDIASTREAM,metaData:{hasAudio:!1,hasVideo:!1,width:0,height:0,framerate:0},gotMetaData:!1,tags:{video:void 0,audio:void 0}},this._videoDeviceConfig={},this.defineEvents(["StreamActive","StreamInactive","StreamAddTrack","StreamRemoveTrack","StreamTrackEnded"])}var a=i.debug_,s=i.warning_,o=i.error_,d=(i.success_,i.isBool),c=i.isUint,u=i.isString,h=i.isFunction,l=i.parseJSON,m=r.prototype=Object.create(n.prototype);return m.getMetaData=function(){return this._devices.metaData},m.getMediaId=function(){return this._mediaId},m.getMediaIndex=function(){return this._mediaIndex},m.getMediaType=function(){return this._mediaType},m.getLocalMediaStream=function(){return this._devices.stream},m.getUserMediaConstraints=function(){return this._devices.constraints},m.screenCaptureAvailable=function(){return this._nanoScreenCapture.isScreenCaptureAvailable()},m._addPayload=function(e){return e=e||{},e.data={},e.data.mediaId=this._mediaId,e.data.mediaIndex=this._mediaIndex,e.data.mediaType=this._mediaType,e},m.getMediaStreamState=function(){return this._devices.state=this._devices.stream?this._devices.stream.active?t.STREAM_ACTIVE:t.STREAM_INACTIVE:t.STREAM_NOMEDIASTREAM},m.getDevices=function(e,t){if(null===this.screenCaptureAvailable()&&this._useScreenCapture){var i=this;setTimeout(function(){i._getDevicesWithoutSC=!0},i._timeoutScreenCapture)}this._getDevices(e,t)},m._getDevices=function(e,t){var i=this;if(null===this.screenCaptureAvailable()&&this._useScreenCapture&&!this._getDevicesWithoutSC)return void setTimeout(function(){i._getDevices(e,t)},250);if(this._getDevicesWithoutSC=!1,h(e)){if(t=h(t)?t:console.error,this._devices.enumerated=!1,this._devices.video=[],this._devices.audio=[],!this.screenCaptureAvailable()&&this._useScreenCaptureOnly){var n=this._addPayload();return n.data.error=new Error("screen capture not available, but should only be used"),void t(n)}var r=navigator.mediaDevices;if(!r||!r.enumerateDevices){var n=this._addPayload();return n.data.error=new Error("cant enumerate devices"),void t(n)}r.enumerateDevices().then(function(t){i._onDevicesEnumerated(t,e)}).catch(function(e){var n=i._addPayload();n.data.error=new Error("enumerating devices failed: "+e),t(n)})}},m._onDevicesEnumerated=function(e,t){var i,n,r=0,a=0;if(!this._useScreenCaptureOnly)for(var s=0,o=e.length;s<o;s++)n=e[s],i="videoinput"===n.kind?"video":"audioinput"===n.kind?"audio":"unknown","unknown"!==i&&(this._devices[i].push({label:this._createDeviceLabel(n,i),kind:n.kind,deviceId:n.deviceId,groupId:n.groupId}),this._devices.listed[i].push({id:this._createDeviceLabel(n,i),index:"videoinput"===n.kind?r:a}),"videoinput"===n.kind?r++:a++);this.screenCaptureAvailable()&&(this._useScreenCapture||this._useScreenCaptureOnly)&&(this._devices.video.push({label:this._nanoScreenCapture.getScreenCaptureName()+" (Chrome)",kind:"videoinput",deviceId:"screen",groupId:"",index:r}),this._devices.listed.video.push({id:this._nanoScreenCapture.getScreenCaptureName()+" (Chrome)",index:r})),this._devices.enumerated=!0;var d=this._addPayload();d.data.devices={audiodevices:this._devices.listed.audio,videodevices:this._devices.listed.video},t(d)},m._createDeviceLabel=function(e,t){return e.label.length?e.label:t+"device ID: "+e.deviceId.substr(0,10)},m.getStoredVideoDevices=function(e){this._getStoredDevices("video",e)},m.getStoredAudioDevices=function(e){this._getStoredDevices("audio",e)},m.getStoredDevices=function(e){this._getStoredDevices("both",e)},m._getStoredDevices=function(e,t){if(h(t)){var i=this._addPayload();i.data.devices="video"===e?this._devices.listed.video:"audio"===e?this._devices.listed.audio:"both"===e?{videodevices:this._devices.listed.video,audiodevices:this._devices.listed.audio}:void 0,this._devices.enumerated?t(i):setTimeout(this._getStoredDevices.bind(this,e,t),250)}},m.setVideoDevice=function(e){return this._setDevice(e,"video")},m.setAudioDevice=function(e){return this._setDevice(e,"audio")},m._setDevice=function(e,t){if("video"===t||"audio"===t){var i=e.device;d(i)||(i=this._devices[t][i]);var n=this._devices.selected;if(i)if(i.deviceId){i=l(i),n[t]=!1;for(var r in this._devices[t])if(i.deviceId===this._devices[t][r].deviceId){n[t]=i;break}}else n[t]=!0;else n[t]=!1;return"video"===t&&this._setVideoDeviceConfig(e),n[t]}},m._setVideoDeviceConfig=function(e){e=e||{};var t=e.width||0,i=e.height||0,n=e.framerate||0,r=e.minFramerate||0;n<r&&(s("Framerate is smaller than minFramerate, setting framerate and minFramerate to minFramerate("+r+")"),n=r),this._videoDeviceConfig={},t>0&&i>0&&(this._videoDeviceConfig.width={min:t,max:t,ideal:t},this._videoDeviceConfig.height={min:i,max:i,ideal:i}),n>0&&(this._videoDeviceConfig.frameRate={min:r,max:n,ideal:n}),a("videoDeviceConfig: "+JSON.stringify(this._videoDeviceConfig))},m.getUserMedia=function(e,t){if(h(e)){t=h(t)?t:console.error;try{this.deleteUserMedia();var i=this._devices.selected;if(!i.video&&!i.audio){var n=this._addPayload();return n.data.error="no media set for getUserMedia",void t(n)}if(!d(i.video)&&"screen"===i.video.deviceId&&this.screenCaptureAvailable()){var r=this;this._nanoScreenCapture.once("PermissionDenied",t),this._nanoScreenCapture.getSourceId(function(){r._setConstraints(["screen"]),r._gum(r._promiseUserMediaAudio,e,t)})}else this._promiseUserMedia(e,t)}catch(e){var n=this._addPayload();n.data.error=e,t(n)}}},m.deleteUserMedia=function(e,i){try{if(null!==this._devices.stream){this._devices.stream.onactive=void 0,this._devices.stream.oninactive=void 0,this._devices.stream.onaddtrack=void 0,this._devices.stream.onremovetrack=void 0;var n=[].concat(this._devices.stream.getVideoTracks()).concat(this._devices.stream.getAudioTracks());for(var r in n)n[r].onended=void 0}this._stopTracks(this._devices.stream.getVideoTracks()),this._stopTracks(this._devices.stream.getAudioTracks()),this._devices.stream=null,this._devices.state=t.STREAM_NOMEDIASTREAM,this._devices.metaData={hasAudio:!1,hasVideo:!1,width:0,height:0,framerate:0},this._devices.gotMetaData=!1;var a=this._addPayload();a.data.stream=this._devices.stream,h(e)&&e(a)}catch(e){var a=this._addPayload();a.data.error=e,h(i)&&i(a)}},m._gum=function(e,t,i){var n=navigator.mediaDevices;if(!n||!h(n.getUserMedia))return void i(new Error("navigator.mediaDevices.getUserMedia() not defined"));var r=this;n.getUserMedia(this._devices.constraints).then(function(n){e.call(r,n,t,i)}).catch(function(e){var t=r._addPayload();t.data.error=e,i(t)})},m._promiseUserMediaAudio=function(e,t,i){
this._devices.selected.audio?(this.deleteUserMedia(),this._devices.stream=e,this._setConstraints(["audio"]),this._gum(this._onGetUserMediaAudio,t,i)):this._replaceMediaStream(e,t,i)},m._promiseUserMedia=function(e,t){this._setConstraints(["video","audio"]),this._gum(this._replaceMediaStream,e,t)},m._onGetUserMediaAudio=function(e,t,i){var n=e.getAudioTracks()[0];if(!n){var r=this._addPayload();return r.data.error=new Error('in "getUserMedia": no audio track to add'),void i(r)}this._devices.stream.addTrack(n);var a=this._nanoScreenCapture.getScreenConstraints(this._videoDeviceConfig);this._devices.constraints.video=a.video,this._installMediaStream(),this._prepareMediaStream(t,i)},m._replaceMediaStream=function(e,t,i){this.deleteUserMedia(),this._devices.stream=e,this._installMediaStream(),this._prepareMediaStream(t,i)},m._installMediaStream=function(){this._devices.stream.onactive=this._onActive.bind(this),this._devices.stream.oninactive=this._onInactive.bind(this),this._devices.stream.onaddtrack=this._onAddTrack.bind(this),this._devices.stream.onremovetrack=this._onRemoveTrack.bind(this);var e=[].concat(this._devices.stream.getVideoTracks()).concat(this._devices.stream.getAudioTracks());for(var i in e)e[i].onended=this._onTrackEnded.bind(this);this._devices.state=t.STREAM_ACTIVE},m._prepareMediaStream=function(e,t){var i=this,n=this._devices.stream.getVideoTracks(),r=this._devices.stream.getAudioTracks(),a=[].concat(n).concat(r),s=!!a.length;if(s){var o,d=!0;for(var c in a)if(o=a[c],o.readyState&&(!d||"live"!==o.readyState)){d=!1;var u=this._addPayload();u.data.error="media stream received but no "+a[c].kind+' data from device "'+a[c].label+'", maybe in use from another app',t(u);break}if(!d)return;n.length?(this._devices.tags.video=document.createElement("video"),this._devices.tags.video.onloadedmetadata=function(){i._onMetaData(this,n,r,e,t)},this._devices.tags.video.autoplay=!0,this._devices.tags.video.muted=!0,this._devices.tags.video.srcObject=this._devices.stream):r.length&&(this._devices.tags.audio=document.createElement("audio"),this._devices.tags.audio.onloadedmetadata=function(){i._onMetaData(this,n,r,e,t)},this._devices.tags.audio.autoplay=!0,this._devices.tags.audio.muted=!0,this._devices.tags.audio.srcObject=this._devices.stream)}else{var u=this._addPayload();u.data.error="media stream received, but no tracks",t(u)}},m._onMetaData=function(e,i,n,r,a){if(!this._devices.gotMetaData){if(this._devices.gotMetaData=!0,e.videoWidth&&e.videoHeight&&0<e.videoWidth&&e.videoWidth<10||0<e.videoHeight&&e.videoHeight<10){var s=this._addPayload();s.data.error="media stream received but no video data from device "+i[0].label+", maybe in use from another app",a(s)}else if(e.duration&&e.duration!==1/0||e.ended||e.error){var s=this._addPayload();s.data.error="media stream received but no audio data from device "+n[0].label+", maybe in use from another app",a(s)}else{var o=this._devices.metaData;o.hasVideo=!!i.length,o.hasAudio=!!n.length,o.width=e.videoWidth||0,o.height=e.videoHeight||0,o.framerate=e.playbackRate;try{var s=this._addPayload();s.data.stream=this._devices.stream,s.data.metadata=this._devices.metaData,s.data.constraints=this._devices.constraints,this._state=t.STREAM_ACTIVE,r(s)}catch(e){var s=this._addPayload();s.data.error=e,a(s)}}this._devices.tags.video&&(this._devices.tags.video.src="",this._devices.tags.video=void 0),this._devices.tags.audio&&(this._devices.tags.audio.src="",this._devices.tags.audio=void 0)}},m._onActive=function(e){this._devices.state=t.STREAM_ACTIVE;var i=this._addPayload(e);i.name="StreamActive",this.emit(i.name,i)},m._onInactive=function(e){this._devices.state=t.STREAM_INACTIVE;var i=this._addPayload(e);i.name="StreamInactive",this.emit(i.name,i)},m._onAddTrack=function(e){var t=this._addPayload(e);t.name="StreamAddTrack",this.emit(t.name,t)},m._onRemoveTrack=function(e){var t=this._addPayload(e);t.name="StreamRemoveTrack",this.emit(t.name,t)},m._onTrackEnded=function(e){this._devices.state=t.STREAM_ENDED;var i=this._addPayload(e);i.name="StreamTrackEnded",this.emit(i.name,i)},m._stopTracks=function(e){for(var t in e)e[t].stop()},m._setConstraints=function(e){for(var t={audio:!1,video:!1},i=0,n=e.length;i<n;i++)switch(e[i]){case"video":d(this._devices.selected.video)?t.video=this._devices.selected.video:(t.video=this._videoDeviceConfig,t.video.sourceId=this._devices.selected.video.deviceId);break;case"audio":d(this._devices.selected.audio)?t.audio=this._devices.selected.audio:(t.audio={},t.audio.sourceId=this._devices.selected.audio.deviceId);break;case"screen":t=this._nanoScreenCapture.getScreenConstraints(this._videoDeviceConfig)}this._devices.constraints=t,a("constraints: "+JSON.stringify(t))},m.muteVideoTracks=function(e){this._muteTracks("video",e)},m.muteAudioTracks=function(e){this._muteTracks("audio",e)},m._muteTracks=function(e,t){if(this._devices.stream){var i="video"===e?this._devices.stream.getVideoTracks():"audio"===e?this._devices.stream.getAudioTracks():void 0;if(i){for(var n in i)i[n].enabled=!t;this._devices.muted[e]=t}}},r}),define("nano.remotemedia",["nano.const","nano.tools","EventEmitter"],function(e,t,i){"use strict";function n(t,n){return i.call(this),"string"==typeof t||t instanceof String?Number(n)!==n||n%1!==0?void r("RemoteMedia: param mediaIndex must be an integer",2):(this._mediaId=t,this._mediaIndex=n,this._mediaType="remote",this._state=e.STREAM_NOMEDIASTREAM,this._metaData={hasAudio:!1,hasVideo:!1,width:0,height:0,framerate:0},this._gotMetaData=!1,this._tags={video:void 0,audio:void 0},void this.defineEvents(["StreamActive","StreamInactive","StreamAddTrack","StreamRemoveTrack","StreamTrackEnded"])):void r("RemoteMedia: param mediaId must be of type string",2)}var r=(t.debug_,t.warning_,t.error_),a=(t.success_,n.prototype=Object.create(i.prototype));return a.getMediaId=function(){return this._mediaId},a.getMediaIndex=function(){return this._mediaIndex},a.getMediaType=function(){return this._mediaType},a.getRemoteMediaStream=function(){return this._stream},a._addPayload=function(e){return e=e||{},e.data={},e.data.mediaId=this._mediaId,e.data.mediaIndex=this._mediaIndex,e.data.mediaType=this._mediaType,e},a.getMediaStreamState=function(){return this._state=this._stream?this._stream.active?e.STREAM_ACTIVE:e.STREAM_INACTIVE:e.STREAM_NOMEDIASTREAM},a.addMediaStream=function(e,t,i){this.removeMediaStream(),this._stream=e,this._installMediaStream(),this._prepareMediaStream(t,i)},a._installMediaStream=function(e,t){this._stream.onactive=this._onActive.bind(this),this._stream.oninactive=this._onInactive.bind(this),this._stream.onaddtrack=this._onAddTrack.bind(this),this._stream.onremovetrack=this._onRemoveTrack.bind(this);var i=[].concat(this._stream.getVideoTracks()).concat(this._stream.getAudioTracks());for(var n in i)i[n].onended=this._onTrackEnded.bind(this)},a._prepareMediaStream=function(e,t){var i=this,n=this._stream.getVideoTracks(),r=this._stream.getAudioTracks(),a=[].concat(n).concat(r),s=!!a.length;if(s)n.length?(this._tags.video=document.createElement("video"),this._tags.video.onloadedmetadata=function(){i._onMetaData(this,n,r,e,t)},this._tags.video.autoplay=!0,this._tags.video.muted=!0,this._tags.video.srcObject=this._stream):r.length&&(this._tags.audio=document.createElement("audio"),this._tags.audio.onloadedmetadata=function(){i._onMetaData(this,n,r,e,t)},this._tags.audio.autoplay=!0,this._tags.audio.muted=!0,this._tags.audio.srcObject=this._stream);else{var o=this._addPayload();o.data.error="media stream added, but no tracks",t(o)}},a._onMetaData=function(t,i,n,r,a){if(!this._gotMetaData){this._gotMetaData=!0,this._metaData.hasVideo=!!i.length,this._metaData.hasAudio=!!n.length,this._metaData.width=t.videoWidth?t.videoWidth:0,this._metaData.height=t.videoHeight?t.videoHeight:0,this._metaData.framerate=t.playbackRate;try{var s=this._addPayload();s.data.stream=this._stream,s.data.metadata=this._metaData,this._state=e.STREAM_ACTIVE,r(s)}catch(e){var s=this._addPayload();s.data.error=e,a(s)}this._tags.video&&(this._tags.video.src="",this._tags.video=void 0),this._tags.audio&&(this._tags.audio.src="",this._tags.audio=void 0)}},a._onActive=function(t){this._state=e.STREAM_ACTIVE;var i=this._addPayload(t);i.name="StreamActive",this.emit(i.name,i)},a._onInactive=function(t){this._state=e.STREAM_INACTIVE;var i=this._addPayload(t);i.name="StreamInactive",this.emit(i.name,i)},a._onAddTrack=function(e){var t=this._addPayload(e);t.name="StreamAddTrack",this.emit(t.name,t)},a._onRemoveTrack=function(e){var t=this._addPayload(e);t.name="StreamRemoveTrack",this.emit(t.name,t)},a._onTrackEnded=function(t){this._state=e.STREAM_ENDED;var i=this._addPayload(t);i.name="StreamTrackEnded",this.emit(i.name,i)},a.removeMediaStream=function(t,i){try{if(null!==this._stream){this._stream.onactive=void 0,this._stream.oninactive=void 0,this._stream.onaddtrack=void 0,this._stream.onremovetrack=void 0;var n=[].concat(this._stream.getVideoTracks()).concat(this._stream.getAudioTracks());for(var r in n)n[r].onended=void 0}this._stopTracks(this._stream.getVideoTracks()),this._stopTracks(this._stream.getAudioTracks()),this._stream=null,this._state=e.STREAM_NOMEDIASTREAM,this._metaData={hasAudio:!1,hasVideo:!1,width:0,height:0,framerate:0},this._gotMetaData=!1;var a=this._addPayload();a.data.stream=this._stream,!!t&&t(a)}catch(e){var a=this._addPayload();a.data.error=e,!!i&&i(a)}},a._stopTracks=function(e){for(var t in e)e[t].stop()},a.muteVideoTracks=function(e){this._muteTracks("video",e)},a.muteAudioTracks=function(e){this._muteTracks("audio",e)},a._muteTracks=function(e,t){if(this._stream){var i="video"===e?this._stream.getVideoTracks():"audio"===e?this._stream.getAudioTracks():void 0;if(i){for(var n in i)i[n].enabled=!t;this._muted[e]=t}}},n}),define("nano.mediacontroller",["nano.localmedia","nano.remotemedia","nano.const","EventEmitter","nano.tools"],function(e,t,i,n,r){"use strict";function a(){n.call(this),this._localMedia=[],this._remoteMedia=[]}var s=r.isInt,o=r.isString,d=a.prototype=Object.create(n.prototype);return d._findBy=function(e,t,i){i=i||"local";for(var n=this["_"+i+"Media"],r=0,a=n.length;r<a;r++)if(n[r][e]===t)return n[r];return null},d._find=function(e,t,i){i=i||"local";for(var n=this["_"+i+"Media"],r=0,a=n.length;r<a;r++)if(n[r]===t)return n[r][e];return null},d._reemit=function(e){this.emit(e.name,e)},d._return=function(e,t,i,n){var r;if(s(t))return r=this["get"+n+"MediaByIndex"].call(this,t),[r[e].apply(r,i)];if(o(t))return r=this["get"+n+"MediaById"].call(this,t),[r[e].apply(r,i)];var a=[];i.pop(),i.unshift(t);for(var d=this["_"+n.toLowerCase()+"Media"],c=0,u=d.length;c<u;c++)a.push(d[c][e].apply(d[c],i));return a},d._addMedia=function(i,n,r,a,d){o(i)||__error("MediaController: param mediaId must be of type string",2),s(n)||__error("MediaController: param mediaIndex must be an integer",2);var c="Local"===d?new e(i,n,r,a):new t(i,n);c.on("StreamActive",this._reemit.bind(this)),c.on("StreamInactive",this._reemit.bind(this)),c.on("StreamTrackEnded",this._reemit.bind(this)),c.on("StreamAddTrack",this._reemit.bind(this)),c.on("StreamRemoveTrack",this._reemit.bind(this));for(var u=this["_"+d.toLowerCase()+"Media"],h=0,l=u.length;h<l;h++)u[h].getMediaId()===i&&u.splice(h,1);u.push(c)},d._removeMedia=function(e,t){var i;if(s(e))i=this["get"+t+"MediaByIndex"].call(this,e);else{if(!o(e))return void(this["_"+t.toLowerCase()+"Media"]=[]);i=this["get"+t+"MediaById"].call(this,e)}for(var n=this["_"+t.toLowerCase()+"Media"],r=0,a=n.length;r<a;r++)n[r]===i&&n.splice(r,1)},d.addLocalMedia=function(e,t,i,n){this._addMedia(e,t,i,n,"Local")},d.removeLocalMedia=function(e){this._removeMedia(e,"Local")},d.getLocalMediaIndexes=function(){for(var e=[],t=0,i=this._localMedia.length;t<i;t++)e.push(this.getLocalMediaIndex(this._localMedia.getMediaIndex()));return e},d.getLocalMediaIds=function(){for(var e=[],t=0,i=this._localMedia.length;t<i;t++)e.push(this.getLocalMediaIndex(this._localMedia.getMediaId()));return e},d.getLocalMedias=function(){return this._localMedia},d.getLocalMediaByIndex=function(e){return this._findBy("_mediaIndex",e,"local")},d.getLocalMediaById=function(e){return this._findBy("_mediaId",e,"local")},d.getLocalMediaIndex=function(e){return this._find("_mediaIndex",e,"local")},d.getLocalMediaId=function(e){return this._find("_mediaId",e,"local")},d.getLocalMediaIdByIndex=function(e){return this.getLocalMediaByIndex(e)?this.getLocalMediaByIndex(e).getMediaId():null},d.getLocalMediaIndexById=function(e){return this.getLocalMediaById(e)?this.getLocalMediaById(e).getMediaIndex():null},d.getLocalMediaMetaData=function(e){return this._return("getMetaData",e,[],"Local")},d.getLocalMediaStream=function(e){return this._return("getLocalMediaStream",e,[],"Local")},d.getUserMediaConstraints=function(e){return this._return("getUserMediaConstraints",e,[],"Local")},d.screenCaptureAvailable=function(e){return this._return("screenCaptureAvailable",e,[],"Local")},d.getLocalMediaStreamState=function(e){return this._return("getLocalMediaStreamState",e,[],"Local")},d.getDevices=function(e,t,i){this._return("getDevices",e,[t,i],"Local")},d.getStoredVideoDevices=function(e,t){this._return("getStoredVideoDevices",e,[t],"Local")},d.getStoredAudioDevices=function(e,t){this._return("getStoredAudioDevices",e,[t],"Local")},d.getStoredDevices=function(e,t){this._return("getStoredDevices",e,[t],"Local")},d.setVideoDevice=function(e,t){return this._return("setVideoDevice",e,[t],"Local")},d.setAudioDevice=function(e,t){return this._return("setAudioDevice",e,[t],"Local")},d.getUserMedia=function(e,t,i){this._return("getUserMedia",e,[t,i],"Local")},d.deleteUserMedia=function(e,t,i){this._return("deleteUserMedia",e,[t,i],"Local")},d.muteVideoTracks=function(e,t){this._return("muteVideoTracks",e,[t],"Local")},d.muteAudioTracks=function(e,t){this._return("muteAudioTracks",e,[t],"Local")},d.addRemoteMedia=function(e,t){this._addMedia(e,t,void 0,void 0,"Remote")},d.removeRemoteMedia=function(e){this._removeMedia(e,"Remote")},d.getRemoteMediaIndexes=function(){for(var e=[],t=0,i=this._remoteMedia.length;t<i;t++)e.push(this.getRemoteMediaIndex(this._remoteMedia.getMediaIndex()));return e},d.getRemoteMediaIds=function(){for(var e=[],t=0,i=this._remoteMedia.length;t<i;t++)e.push(this.getRemoteMediaIndex(this._remoteMedia.getMediaId()));return e},d.getRemoteMedias=function(){return this._remoteMedia},d.getRemoteMediaByIndex=function(e){return this._findBy("_mediaIndex",e,"remote")},d.getRemoteMediaById=function(e){return this._findBy("_mediaId",e,"remote")},d.getRemoteMediaIndex=function(e){return this._find("_mediaIndex",e,"remote")},d.getRemoteMediaId=function(e){return this._find("_mediaId",e,"remote")},d.getRemoteMediaIdByIndex=function(e){return this.getRemoteMediaByIndex(e).getMediaId()},d.getRemoteMediaIndexById=function(e){return this.getRemoteMediaById(e).getMediaIndex()},d.getRemoteMediaStream=function(e){return this._return("getRemoteMediaStream",e,[],"Remote")},d.getRemoteMediaStreamState=function(e){return this._return("getRemoteMediaStreamState",e,[],"Remote")},d.addRemoteMediaStream=function(e,t,i){this._return("addRemoteMediaStream",e,[t,i],"Remote")},d.removeRemoteMediaStream=function(e,t,i){this._return("removeRemoteMediaStream",e,[t,i],"Remote")},a}),define("nano.userlist",["nano.const","nano.tools"],function(e,t){"use strict";function i(e){this._ownerId=e,this._list={}}var n=t.debug_,r=t.stringifyJSON,a=i.prototype;return a.createPublicUserList=function(){var e=[],t=this._list;for(var i in t){var a=t[i];e.push({remoteUserId:i,remotePeerId:a[a.length-1],remoteUserName:a[1],state:a[0]})}return e.sort(function(e,t){if(e.remotePeerId<t.remotePeerId)return 1}),n("userlist::createPublicUserList: "+r(e)),e},a.updateEntry=function(e){var t=e.data,i=t.remotePeerName.split("_");i[0]!==""+this._ownerId&&(n("userList::updateEntry: name="+i[1]+", userId="+i[0]+", "+r(t)),1===t.connected?this._add(i[0],i[1],t.remotePeerId):this._remove(i[0],t.remotePeerId,e.target.getRemotePeerId()))},a._add=function(t,i,a){this._list[t]?this._list[t].push(a):this._list[t]=[e.CHANNEL_SIGNED_IN,i,a],n("userList::add: name="+i+", userId="+t+", "+r(this._list))},a._remove=function(t,i,a){var s=this._list[t];if(s){for(var o,d=2,c=s.length;d<c;d++)s[d]===i&&(s.splice(d,1),i===a&&(s[0]=e.CHANNEL_SIGNED_IN),o=s[1],2===s.length&&delete this._list[t]);n("userList::remove: name="+o+", userId="+t+", "+r(this._list))}},a.updateEntryState=function(t){if(t.getRole()===e.ROLE_BROADCASTER)return!1;var i,a,s,o=!1,d=!1;for(var c in this._list){s=this._list[c];for(var u=2,h=s.length;u<h;u++)s[u]==t.getRemotePeerId()&&(n("userList::updateEntryState: state(old)="+s[0]+", name="+s[1]+", userId="+c+", "+r(this._list)),i=t.getState(),a=s[0],i===e.CHANNEL_IDLE?(n("userList::updateEntryState:  CM REMOVED state=1, name="+s[1]+", userId="+c+", "+r(this._list)),s.splice(u,0),s[0]=e.CHANNEL_SIGNED_IN,2===s.length&&(delete this._list[c],n("userList::updateEntryState:  USER REMOVED state=1, name="+s[1]+", userId="+c+", "+r(this._list))),d=!0):i!==a?(s[0]=i,n("userList::updateEntryState: state(new)="+s[0]+", name="+s[1]+", userId="+c+", "+r(this._list)),d=!0):(n("userList::updateEntryState: NO UPDATE state="+s[0]+", name="+s[1]+", userId="+c+", "+r(this._list)),d=!1),o=!0);if(o||c===t.getRemoteUserId()&&t.getState()===e.CHANNEL_IDLE&&(n("userList::updateEntryState: state(old)="+s[0]+", name="+s[1]+", userId="+c+", "+r(this._list)),s[0]=e.CHANNEL_SIGNED_IN,2===s.length&&(delete this._list[c],n("userList::updateEntryState:  USER REMOVED state=1, name="+s[1]+", userId="+c+", "+r(this._list))),o=!0,d=!0),o)break}return d},a.getUserNameByRemotePeerId=function(e){return this._getByRemotePeerId(e,"name")},a.getUserStateByRemotePeerId=function(e){return this._getByRemotePeerId(e,"state")},a.getUserIdByRemotePeerId=function(e){return this._getByRemotePeerId(e,"remoteUserId")},a.getUserStateByRemoteUserId=function(e){return this._getByRemoteUserId(e,"state")},a.getUserNameByRemoteUserId=function(e){return this._getByRemoteUserId(e,"name")},a.getFreePeerIdByRemoteUserId=function(e){return this._getByRemoteUserId(e,"freePeer")},a._getByRemotePeerId=function(e,t){var i,n,r=this._list;for(i in r){n=r[i];for(var a=2,s=n.length;a<s;a++)if(e===n[a])return"remoteUserId"===t?i:"state"===t?n[0]:"name"===t?n[1]:void 0}},a._getByRemoteUserId=function(e,t){var i,n=this._list;for(var r in n)if(r===e)return i=n[r],i["state"===t?0:"name"===t?1:"freePeer"===t?i.length-1:void 0]},i}),define("nano.channelmemberlist",["nano.const","nano.tools"],function(e,t){"use strict";function i(){this._broadcaster=void 0,this._chatters=[],this._viewers=[]}var n=t.debug_,r=i.prototype;return r.getFreeChatter=function(){var t=this._chatters.length>0&&this._chatters[this._chatters.length-1].getState()===e.CHANNEL_SIGNED_IN?this._chatters[this._chatters.length-1]:null;if(t)return n("ChannelMemberlist::getFreeChatter: Chatter "+t.getPeerId()+" with state "+t.getState()),t},r.getBroadcaster=function(){return this._broadcaster},r.findById=function(e){return this._findBy("_peerId",e)},r.findByRemoteId=function(e){return this._findBy("_remotePeerId",e)},r.findByRemoteUserId=function(e){return this._findBy("_remoteUserId",e)},r._findBy=function(e,t){for(var i=this._chatters,n=0,r=i.length;n<r;n++)if(i[n][e]===t)return i[n]},r.add=function(t){switch(t.getRole()){case e.ROLE_BROADCASTER:if(this._broadcaster)throw new Error("only one broadcaster atm, you tried to make a second");this._broadcaster=t,n("ChannelMemberlist::add: Broadcaster "+t.getPeerId()+" added ");break;case e.ROLE_VIEWER:this._viewers.push(t),n("ChannelMemberList::add: Viewer "+t.getPeerId()+" added ");break;case e.ROLE_MONITOR:break;case e.ROLE_MIXED:break;case e.ROLE_CHATTER:this._chatters.push(t),n("ChannelMemberList::add: Chatter "+t.getPeerId()+" added ("+this._listChatters()+")");break;case e.ROLE_TRANSCODER:break;default:throw new Error("unknown channelmember role")}},r.remove=function(e){for(var t=this._chatters,i=0,r=t.length;i<r;i++)if(t[i]===e)return n("ChannelMemberList::remove: Chatter "+e.getPeerId()+" removed ("+this._listChatters()+")"),void t.splice(i,1);e===this._broadcaster&&(this._broadcaster=void 0)},r.getChatters=function(){return n("ChannelMemberList::getChatters: ("+this._listChatters()+")"),this._chatters},r.signOutChatters=function(t){n("ChannelMemberList::signOutChatters: ("+this._listChatters()+")");for(var i=this._chatters,r=0,a=i.length;r<a;r++)i[r].getState()!==e.CHANNEL_IDLE&&i[r].signOut(t);i.length=0},r.signOutBroadcaster=function(e){this._broadcaster&&n("ChannelMemberList::signOutBroadcaster: ("+this._broadcaster.getPeerId()+")"),this._broadcaster&&this._broadcaster.signOut(e),this._broadcaster=void 0},r._listChatters=function(){for(var e=this._chatters,t="chatter count: "+e.length+" [",i=0,r=e.length;i<r;i+=1)t+=e[i].getPeerId(),t+=i<r-1?",":"";return t+="]",n("ChannelMemberList::listChatters: ("+t+")"),t},i}),define("nano.hangingget",["EventEmitter","nano.tools"],function(e,t){"use strict";function i(t,i){e.call(this),this._prefix="[MSG CM "+i+" HangingGet] ",s(t)||a(this._prefix+"param server must be of type string",2),o(i)||a(this._prefix+"param id must be an integer",2),this._server=t,this._peerId=i,this._callUrl=t+"/wait?peer_id="+this._peerId,this._aborted=!1,this._request=void 0,this._errorCount=0,this._lastErrorTime=0,this._connectRetries=0,this._lastConnectRetryTime=0}var n=t.debug_,r=t.warning_,a=t.error_,s=t.isString,o=t.isInt,d=2500,c=10,u=5,h=i.prototype=Object.create(e.prototype);return h.start=function(){this._aborted||(this._request=new XMLHttpRequest,this._request.withCredentials=!0,this._listenToRequest(),n(this._prefix+this._callUrl),this._request.open("GET",this._callUrl,!0),this._request.timeout=6e4,this._request.send())},h.abort=function(){this._aborted=!0,this._request.abort(),this._request=void 0},h.restart=function(){var e=this;window.setTimeout(function(){e.start()},100)},h._onReadyStateChange=function(){if(this._request&&4===this._request.readyState){var e=this._request.status;switch(e){case 0:return;case 200:this._errorCount=0;break;case 410:return r(this._prefix+"Warning "+e+" from server: peer gone..."),void this.emitSimple("ReceivedServerNotification",{status:e});case 504:r(this._prefix+"Warning "+e+" from server: gateway timeout... ignoring...");break;default:r(this._prefix+"Warning "+e+" from server: "+this._request.statusText),this.emitSimple("HangingGetServerStatus",{request:this._request,server:this._server,status:e,text:this._request.statusText})}var t=this._readResponseHeader("Pragma");if(0===t){var i=(new Date).getTime(),s=i-this._lastConnectRetryTime;if(this._lastConnectRetryTime=i,s<d&&(this._connectRetries++,n(this._prefix+"XHR result error - increasing error counter. retries="+this._connectRetries+" t="+s)),this._connectRetries>c)return a(this._prefix+"XHR result error - invalid response - stopping (maxRetries reached)"),void this.emitSimple("HangingGetError",{request:this._request,server:this._server,status:e,text:"Server not (yet) up"});r(this._prefix+"XHR result error - invalid response - but retrying - "+this._connectRetries+" t="+s)}else t===this._peerId?(this._connectRetries=0,this.emitSimple("ReceivedServerNotification",{response:this._request.responseText,status:e})):(this._connectRetries=0,this.emitSimple("ReceivedServerMessage",{response:this._request.responseText,peerId:t}));this.restart()}},h._onError=function(e){if(this._request){var t=!0;try{r(this._prefix+" XHR hanging error."+e);var i=e.timeStamp,s=i-this._lastErrorTime;if(this._lastErrorTime=i,s<d&&(n(this._prefix+" XHR hanging error - increasing error counter. "+this._errorCount+" t="+s),this._errorCount++),this._errorCount>u){var o="XHR too many errors, disconnecting.";a(this._prefix+o),this.emitSimple("HangingGetError",{request:this._request,server:this._server,status:e,text:o}),t=!1}}catch(i){a(this._prefix+"Error in request.onerror: "+i),this.emitSimple("HangingGetError",{request:this._request,server:this._server,status:e,text:"Error in request.onerror: "+i}),t=!1}if(t){var c=this;setTimeout(function(){c._errorCount>0&&n(c._prefix+"XHR restart... "+c._errorCount+" t="+s),c.start()},1e3)}}},h._listenToRequest=function(){if(!this._request)return void a(this._prefix+" Request not initialized!");var e=this;this._request.onreadystatechange=function(t){e._onReadyStateChange()},this._request.onerror=function(t){e._onError(t)},this._request.ontimeout=function(t){n(this._prefix+"XHR hanging timeout with status="+t+". retrying..."),e.start()},this._request.onabort=function(e){n(this._prefix+"XHR hanging aborted with status="+e)},this._request.onprogress=function(e){},this._request.onloadstart=function(e){},this._request.onloadend=function(e){}},h._readResponseHeader=function(e){var t=this._request.getResponseHeader(e);return null===t||0===t.length||isNaN(t)?0:parseInt(t,10)},i}),define("sdputils",function(){}),define("nano.sdputilwrapper",["sdputils"],function(e){window.trace=function(e){if("\n"===e[e.length-1]&&(e=e.substring(0,e.length-1)),window.performance){var t=(window.performance.now()/1e3).toFixed(3);console.log(t+": "+e)}else console.log(e)}}),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define("adapter",[],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.adapter=e()}}(function(){return function e(t,i,n){function r(s,o){if(!i[s]){if(!t[s]){var d="function"==typeof require&&require;if(!o&&d)return d(s,!0);if(a)return a(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=i[s]={exports:{}};t[s][0].call(u.exports,function(e){var i=t[s][1][e];return r(i?i:e)},u,u.exports,e,t,i,n)}return i[s].exports}for(var a="function"==typeof require&&require,s=0;s<n.length;s++)r(n[s]);return r}({1:[function(e,t,i){var n={};n.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},n.localCName=n.generateIdentifier(),n.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},n.splitSections=function(e){var t=e.split("\nm=");return t.map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},n.matchPrefix=function(e,t){return n.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},n.parseCandidate=function(e){var t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");for(var i={foundation:t[0],component:t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":i.relatedAddress=t[n+1];break;case"rport":i.relatedPort=parseInt(t[n+1],10);break;case"tcptype":i.tcpType=t[n+1]}return i},n.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),"candidate:"+t.join(" ")},n.parseRtpMap=function(e){var t=e.substr(9).split(" "),i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.numChannels=3===t.length?parseInt(t[2],10):1,i},n.writeRtpMap=function(e){var t=e.payloadType;return void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType),"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==e.numChannels?"/"+e.numChannels:"")+"\r\n"},n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),uri:t[1]}},n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+" "+e.uri+"\r\n"},n.parseFmtp=function(e){for(var t,i={},n=e.substr(e.indexOf(" ")+1).split(";"),r=0;r<n.length;r++)t=n[r].trim().split("="),i[t[0].trim()]=t[1];return i},n.writeFmtp=function(e){var t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach(function(t){n.push(t+"="+e.parameters[t])}),t+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return t},n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},n.writeRtcpFb=function(e){var t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},n.parseSsrcMedia=function(e){var t=e.indexOf(" "),i={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(i.attribute=e.substr(t+1,n-t-1),i.value=e.substr(n+1)):i.attribute=e.substr(t+1),i},n.getDtlsParameters=function(e,t){var i=n.splitLines(e);i=i.concat(n.splitLines(t));var r=i.filter(function(e){return 0===e.indexOf("a=fingerprint:")})[0].substr(14),a={role:"auto",fingerprints:[{algorithm:r.split(" ")[0],value:r.split(" ")[1]}]};return a},n.writeDtlsParameters=function(e,t){var i="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),i},n.getIceParameters=function(e,t){var i=n.splitLines(e);i=i.concat(n.splitLines(t));var r={usernameFragment:i.filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:i.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)};return r},n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},n.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=n.splitLines(e),r=i[0].split(" "),a=3;a<r.length;a++){var s=r[a],o=n.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(o){var d=n.parseRtpMap(o),c=n.matchPrefix(e,"a=fmtp:"+s+" ");switch(d.parameters=c.length?n.parseFmtp(c[0]):{},d.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(n.parseRtcpFb),t.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(d.name.toUpperCase())}}}return n.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(n.parseExtmap(e))}),t},n.writeRtpDescription=function(e,t){var i="";return i+="m="+e+" ",i+=t.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){i+=n.writeRtpMap(e),i+=n.writeFmtp(e),i+=n.writeRtcpFb(e)}),i+="a=rtcp-mux\r\n",t.headerExtensions.forEach(function(e){i+=n.writeExtmap(e)}),i},n.parseRtpEncodingParameters=function(e){var t,i=[],r=n.parseRtpParameters(e),a=r.fecMechanisms.indexOf("RED")!==-1,s=r.fecMechanisms.indexOf("ULPFEC")!==-1,o=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),d=o.length>0&&o[0].ssrc,c=n.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.split(" ");return t.shift(),t.map(function(e){return parseInt(e,10)})});c.length>0&&c[0].length>1&&c[0][0]===d&&(t=c[0][1]),r.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var n={ssrc:d,codecPayloadType:parseInt(e.parameters.apt,10),rtx:{payloadType:e.payloadType,ssrc:t}};i.push(n),a&&(n=JSON.parse(JSON.stringify(n)),n.fec={ssrc:t,mechanism:s?"red+ulpfec":"red"},i.push(n))}}),0===i.length&&d&&i.push({ssrc:d});var u=n.matchPrefix(e,"b=");return u.length&&(0===u[0].indexOf("b=TIAS:")?u=parseInt(u[0].substr(7),10):0===u[0].indexOf("b=AS:")&&(u=parseInt(u[0].substr(5),10)),i.forEach(function(e){e.maxBitrate=u})),i},n.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(e,t,i,r){var a=n.writeRtpDescription(e.kind,t);if(a+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),
a+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":"active"),a+="a=mid:"+e.mid+"\r\n",a+=e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var s="msid:"+r.id+" "+e.rtpSender.track.id+"\r\n";a+="a="+s,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n"},n.getDirection=function(e,t){for(var i=n.splitLines(e),r=0;r<i.length;r++)switch(i[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[r].substr(2)}return t?n.getDirection(t):"sendrecv"},t.exports=n},{}],2:[function(e,t,i){!function(){var i=e("./utils"),n=i.log,r=i.browserDetails;t.exports.browserDetails=r,t.exports.extractVersion=i.extractVersion,t.exports.disableLog=i.disableLog;var a=e("./chrome/chrome_shim")||null,s=e("./edge/edge_shim")||null,o=e("./firefox/firefox_shim")||null,d=e("./safari/safari_shim")||null;switch(r.browser){case"opera":case"chrome":if(!a||!a.shimPeerConnection)return void n("Chrome shim is not included in this adapter release.");n("adapter.js shimming chrome."),t.exports.browserShim=a,a.shimGetUserMedia(),a.shimMediaStream(),a.shimSourceObject(),i.shimCreateObjectURL(),a.shimPeerConnection(),a.shimOnTrack();break;case"firefox":if(!o||!o.shimPeerConnection)return void n("Firefox shim is not included in this adapter release.");n("adapter.js shimming firefox."),t.exports.browserShim=o,o.shimGetUserMedia(),i.shimCreateObjectURL(),o.shimSourceObject(),o.shimPeerConnection(),o.shimOnTrack();break;case"edge":if(!s||!s.shimPeerConnection)return void n("MS edge shim is not included in this adapter release.");n("adapter.js shimming edge."),t.exports.browserShim=s,s.shimGetUserMedia(),i.shimCreateObjectURL(),s.shimPeerConnection();break;case"safari":if(!d)return void n("Safari shim is not included in this adapter release.");n("adapter.js shimming safari."),t.exports.browserShim=d,d.shimGetUserMedia();break;default:n("Unsupported browser!")}}()},{"./chrome/chrome_shim":3,"./edge/edge_shim":5,"./firefox/firefox_shim":7,"./safari/safari_shim":9,"./utils":10}],3:[function(e,t,i){var n=e("../utils.js").log,r=e("../utils.js").browserDetails,a={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){var t=this;this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(i){var n=new Event("track");n.track=i.track,n.receiver={track:i.track},n.streams=[e.stream],t.dispatchEvent(n)}),e.stream.getTracks().forEach(function(t){var i=new Event("track");i.track=t,i.receiver={track:t},i.streams=[e.stream],this.dispatchEvent(i)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var t=this;return this._srcObject=e,this.src&&URL.revokeObjectURL(this.src),e?(this.src=URL.createObjectURL(e),e.addEventListener("addtrack",function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)}),void e.addEventListener("removetrack",function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)})):void(this.src="")}}))},shimPeerConnection:function(){window.RTCPeerConnection||(window.RTCPeerConnection=function(e,t){return n("PeerConnection"),e&&e.iceTransportPolicy&&(e.iceTransports=e.iceTransportPolicy),new webkitRTCPeerConnection(e,t)},window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype,webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}}));var e=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(t,i,n){var r=this,a=arguments;if(arguments.length>0&&"function"==typeof t)return e.apply(this,arguments);if(0===e.length)return e.apply(this,arguments);var s=function(e){var t={},i=e.result();return i.forEach(function(e){var i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){i[t]=e.stat(t)}),t[i.id]=i}),t},o=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};if(arguments.length>=2){var d=function(e){a[1](o(s(e)))};return e.apply(this,[d,arguments[0]])}return new Promise(function(t,i){e.apply(r,[function(e){t(o(s(e)))},i])}).then(i,n)},r.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){var e=arguments,i=this,n=new Promise(function(n,r){t.apply(i,[e[0],n,r])});return e.length<2?n:n.then(function(){e[1].apply(null,[])},function(t){e.length>=3&&e[2].apply(null,[t])})}}),r.version<52&&["createOffer","createAnswer"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var i=1===arguments.length?arguments[0]:void 0;return new Promise(function(n,r){t.apply(e,[n,r,i])})}return t.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}});var t=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}};t.exports={shimMediaStream:a.shimMediaStream,shimOnTrack:a.shimOnTrack,shimSourceObject:a.shimSourceObject,shimPeerConnection:a.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils.js":10,"./getusermedia":4}],4:[function(e,t,i){var n=e("../utils.js").log;t.exports=function(){var e=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var n="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);var r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];var a={};"number"==typeof n.ideal?(a[r("min",i)]=n.ideal,t.optional.push(a),a={},a[r("max",i)]=n.ideal,t.optional.push(a)):(a[r("",i)]=n.ideal,t.optional.push(a))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",i)]=n.exact):["min","max"].forEach(function(e){void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,i)]=n[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},t=function(t,i){if(t=JSON.parse(JSON.stringify(t)),t&&t.audio&&(t.audio=e(t.audio)),t&&"object"==typeof t.video){var r=t.video.facingMode;if(r=r&&("object"==typeof r?r:{ideal:r}),r&&("user"===r.exact||"environment"===r.exact||"user"===r.ideal||"environment"===r.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode)&&(delete t.video.facingMode,"environment"===r.exact||"environment"===r.ideal))return navigator.mediaDevices.enumerateDevices().then(function(a){a=a.filter(function(e){return"videoinput"===e.kind});var s=a.find(function(e){return e.label.toLowerCase().indexOf("back")!==-1})||a.length&&a[a.length-1];return s&&(t.video.deviceId=r.exact?{exact:s.deviceId}:{ideal:s.deviceId}),t.video=e(t.video),n("chrome: "+JSON.stringify(t)),i(t)});t.video=e(t.video)}return n("chrome: "+JSON.stringify(t)),i(t)},i=function(e){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},r=function(e,n,r){t(e,function(e){navigator.webkitGetUserMedia(e,n,function(e){r(i(e))})})};navigator.getUserMedia=r;var a=function(e){return new Promise(function(t,i){navigator.getUserMedia(e,t,i)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:a,enumerateDevices:function(){return new Promise(function(e){var t={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(i){e(i.map(function(e){return{label:e.label,kind:t[e.kind],deviceId:e.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var s=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(e){return t(e,function(e){return s(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(i(e))})})}}else navigator.mediaDevices.getUserMedia=function(e){return a(e)};"undefined"==typeof navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){n("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){n("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":10}],5:[function(e,t,i){var n=e("sdp"),r=e("../utils").browserDetails,a={shimPeerConnection:function(){if(window.RTCIceGatherer){window.RTCIceCandidate||(window.RTCIceCandidate=function(e){return e}),window.RTCSessionDescription||(window.RTCSessionDescription=function(e){return e});var e=Object.getOwnPropertyDescriptor(MediaStreamTrack.prototype,"enabled");Object.defineProperty(MediaStreamTrack.prototype,"enabled",{set:function(t){e.set.call(this,t);var i=new Event("enabled");i.enabled=t,this.dispatchEvent(i)}})}window.RTCPeerConnection=function(e){var t=this,i=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){t[e]=i[e].bind(i)}),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return t.localStreams},this.getRemoteStreams=function(){return t.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},e&&e.iceTransportPolicy)switch(e.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=e.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}if(this.usingBundle=e&&"max-bundle"===e.bundlePolicy,e&&e.iceServers){var n=JSON.parse(JSON.stringify(e.iceServers));this.iceOptions.iceServers=n.filter(function(e){if(e&&e.urls){var t=e.urls;return"string"==typeof t&&(t=[t]),t=t.filter(function(e){return 0===e.indexOf("turn:")&&e.indexOf("transport=udp")!==-1&&e.indexOf("turn:[")===-1||0===e.indexOf("stun:")&&r.version>=14393})[0],!!t}return!1})}this._config=e,this.transceivers=[],this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var e=this,t=n.splitSections(e.localDescription.sdp);this._localIceCandidatesBuffer.forEach(function(i){var n=!i.candidate||0===Object.keys(i.candidate).length;if(n)for(var r=1;r<t.length;r++)t[r].indexOf("\r\na=end-of-candidates\r\n")===-1&&(t[r]+="a=end-of-candidates\r\n");else t[i.candidate.sdpMLineIndex+1]+="a="+i.candidate.candidate+"\r\n";if(e.localDescription.sdp=t.join(""),e.dispatchEvent(i),null!==e.onicecandidate&&e.onicecandidate(i),!i.candidate&&"complete"!==e.iceGatheringState){var a=e.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});a&&(e.iceGatheringState="complete")}}),this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype.getConfiguration=function(){return this._config},window.RTCPeerConnection.prototype.addStream=function(e){var t=e.clone();e.getTracks().forEach(function(e,i){var n=t.getTracks()[i];e.addEventListener("enabled",function(e){n.enabled=e.enabled})}),this.localStreams.push(t),this._maybeFireNegotiationNeeded()},window.RTCPeerConnection.prototype.removeStream=function(e){var t=this.localStreams.indexOf(e);t>-1&&(this.localStreams.splice(t,1),this._maybeFireNegotiationNeeded())},window.RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},window.RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},window.RTCPeerConnection.prototype._getCommonCapabilities=function(e,t){var i={codecs:[],headerExtensions:[],fecMechanisms:[]};return e.codecs.forEach(function(e){for(var n=0;n<t.codecs.length;n++){var r=t.codecs[n];if(e.name.toLowerCase()===r.name.toLowerCase()&&e.clockRate===r.clockRate){r.numChannels=Math.min(e.numChannels,r.numChannels),i.codecs.push(r),r.rtcpFeedback=r.rtcpFeedback.filter(function(t){for(var i=0;i<e.rtcpFeedback.length;i++)if(e.rtcpFeedback[i].type===t.type&&e.rtcpFeedback[i].parameter===t.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var n=0;n<t.headerExtensions.length;n++){var r=t.headerExtensions[n];if(e.uri===r.uri){i.headerExtensions.push(r);break}}}),i},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(e,t){var i=this,r=new RTCIceGatherer(i.iceOptions),a=new RTCIceTransport(r);r.onlocalcandidate=function(s){var o=new Event("icecandidate");o.candidate={sdpMid:e,sdpMLineIndex:t};var d=s.candidate,c=!d||0===Object.keys(d).length;c?void 0===r.state&&(r.state="completed"):(d.component="RTCP"===a.component?2:1,o.candidate.candidate=n.writeCandidate(d));var u=n.splitSections(i.localDescription.sdp);c?u[o.candidate.sdpMLineIndex+1]+="a=end-of-candidates\r\n":u[o.candidate.sdpMLineIndex+1]+="a="+o.candidate.candidate+"\r\n",i.localDescription.sdp=u.join("");var h=i._pendingOffer?i._pendingOffer:i.transceivers,l=h.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});switch(i.iceGatheringState){case"new":c||i._localIceCandidatesBuffer.push(o),c&&l&&i._localIceCandidatesBuffer.push(new Event("icecandidate"));break;case"gathering":i._emitBufferedCandidates(),c||(i.dispatchEvent(o),null!==i.onicecandidate&&i.onicecandidate(o)),l&&(i.dispatchEvent(new Event("icecandidate")),null!==i.onicecandidate&&i.onicecandidate(new Event("icecandidate")),i.iceGatheringState="complete");break;case"complete":}},a.onicestatechange=function(){i._updateConnectionState()};var s=new RTCDtlsTransport(a);return s.ondtlsstatechange=function(){i._updateConnectionState()},s.onerror=function(){s.state="failed",i._updateConnectionState()},{iceGatherer:r,iceTransport:a,dtlsTransport:s}},window.RTCPeerConnection.prototype._transceive=function(e,t,i){var r=this._getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);t&&e.rtpSender&&(r.encodings=e.sendEncodingParameters,r.rtcp={cname:n.localCName},e.recvEncodingParameters.length&&(r.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(r)),i&&e.rtpReceiver&&("video"===e.kind&&e.recvEncodingParameters&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),r.encodings=e.recvEncodingParameters,r.rtcp={cname:e.cname},e.sendEncodingParameters.length&&(r.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(r))},window.RTCPeerConnection.prototype.setLocalDescription=function(e){var t,i,r=this;if("offer"===e.type)this._pendingOffer&&(t=n.splitSections(e.sdp),i=t.shift(),t.forEach(function(e,t){var i=n.parseRtpParameters(e);r._pendingOffer[t].localCapabilities=i}),this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===e.type){t=n.splitSections(r.remoteDescription.sdp),i=t.shift();var a=n.matchPrefix(i,"a=ice-lite").length>0;t.forEach(function(e,t){var s=r.transceivers[t],o=s.iceGatherer,d=s.iceTransport,c=s.dtlsTransport,u=s.localCapabilities,h=s.remoteCapabilities,l="0"===e.split("\n",1)[0].split(" ",2)[1];if(!l&&!s.isDatachannel){var m=n.getIceParameters(e,i),p=n.getDtlsParameters(e,i);a&&(p.role="server"),r.usingBundle&&0!==t||(d.start(o,m,a?"controlling":"controlled"),c.start(p));var f=r._getCommonCapabilities(u,h);r._transceive(s,f.codecs.length>0,!1)}})}switch(this.localDescription={type:e.type,sdp:e.sdp},e.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}var s=arguments.length>1&&"function"==typeof arguments[1];if(s){var o=arguments[1];window.setTimeout(function(){o(),"new"===r.iceGatheringState&&(r.iceGatheringState="gathering"),r._emitBufferedCandidates()},0)}var d=Promise.resolve();return d.then(function(){s||("new"===r.iceGatheringState&&(r.iceGatheringState="gathering"),window.setTimeout(r._emitBufferedCandidates.bind(r),500))}),d},window.RTCPeerConnection.prototype.setRemoteDescription=function(e){var t=this,i=new MediaStream,r=[],a=n.splitSections(e.sdp),s=a.shift(),o=n.matchPrefix(s,"a=ice-lite").length>0;switch(this.usingBundle=n.matchPrefix(s,"a=group:BUNDLE ").length>0,a.forEach(function(a,d){var c=n.splitLines(a),u=c[0].substr(2).split(" "),h=u[0],l="0"===u[1],m=n.getDirection(a,s),p=n.matchPrefix(a,"a=mid:");if(p=p.length?p[0].substr(6):n.generateIdentifier(),"application"===h&&"DTLS/SCTP"===u[2])return void(t.transceivers[d]={mid:p,isDatachannel:!0});var f,_,v,g,S,C,b,E,R,I,y,w,T=n.parseRtpParameters(a);l||(y=n.getIceParameters(a,s),w=n.getDtlsParameters(a,s),w.role="client"),E=n.parseRtpEncodingParameters(a);var M,P=n.matchPrefix(a,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];P&&(M=P.value);var L=n.matchPrefix(a,"a=end-of-candidates",s).length>0,A=n.matchPrefix(a,"a=candidate:").map(function(e){return n.parseCandidate(e)}).filter(function(e){return"1"===e.component});if("offer"!==e.type||l)"answer"!==e.type||l||(f=t.transceivers[d],_=f.iceGatherer,v=f.iceTransport,g=f.dtlsTransport,S=f.rtpSender,C=f.rtpReceiver,b=f.sendEncodingParameters,R=f.localCapabilities,t.transceivers[d].recvEncodingParameters=E,t.transceivers[d].remoteCapabilities=T,t.transceivers[d].cname=M,(o||L)&&A.length&&v.setRemoteCandidates(A),t.usingBundle&&0!==d||(v.start(_,y,"controlling"),g.start(w)),t._transceive(f,"sendrecv"===m||"recvonly"===m,"sendrecv"===m||"sendonly"===m),!C||"sendrecv"!==m&&"sendonly"!==m?delete f.rtpReceiver:(I=C.track,r.push([I,C]),i.addTrack(I)));else{var N=t.usingBundle&&d>0?{iceGatherer:t.transceivers[0].iceGatherer,iceTransport:t.transceivers[0].iceTransport,dtlsTransport:t.transceivers[0].dtlsTransport}:t._createIceAndDtlsTransports(p,d);if(!L||t.usingBundle&&0!==d||N.iceTransport.setRemoteCandidates(A),R=RTCRtpReceiver.getCapabilities(h),R.codecs=R.codecs.filter(function(e){return"rtx"!==e.name}),b=[{ssrc:1001*(2*d+2)}],C=new RTCRtpReceiver(N.dtlsTransport,h),I=C.track,r.push([I,C]),i.addTrack(I),t.localStreams.length>0&&t.localStreams[0].getTracks().length>=d){var O;"audio"===h?O=t.localStreams[0].getAudioTracks()[0]:"video"===h&&(O=t.localStreams[0].getVideoTracks()[0]),O&&(S=new RTCRtpSender(O,N.dtlsTransport))}t.transceivers[d]={iceGatherer:N.iceGatherer,iceTransport:N.iceTransport,dtlsTransport:N.dtlsTransport,localCapabilities:R,remoteCapabilities:T,rtpSender:S,rtpReceiver:C,kind:h,mid:p,cname:M,sendEncodingParameters:b,recvEncodingParameters:E},t._transceive(t.transceivers[d],!1,"sendrecv"===m||"sendonly"===m)}}),this.remoteDescription={type:e.type,sdp:e.sdp},e.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}return i.getTracks().length&&(t.remoteStreams.push(i),window.setTimeout(function(){var e=new Event("addstream");e.stream=i,t.dispatchEvent(e),null!==t.onaddstream&&window.setTimeout(function(){t.onaddstream(e)},0),r.forEach(function(e){var n=e[0],r=e[1],a=new Event("track");a.track=n,a.receiver=r,a.streams=[i],t.dispatchEvent(a),null!==t.ontrack&&window.setTimeout(function(){t.ontrack(a)},0)})},0)),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._updateSignalingState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this.dispatchEvent(t),null!==this.onsignalingstatechange&&this.onsignalingstatechange(t)},window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var e=new Event("negotiationneeded");this.dispatchEvent(e),null!==this.onnegotiationneeded&&this.onnegotiationneeded(e)},window.RTCPeerConnection.prototype._updateConnectionState=function(){var e,t=this,i={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};if(this.transceivers.forEach(function(e){i[e.iceTransport.state]++,i[e.dtlsTransport.state]++}),i.connected+=i.completed,e="new",i.failed>0?e="failed":i.connecting>0||i.checking>0?e="connecting":i.disconnected>0?e="disconnected":i.new>0?e="new":(i.connected>0||i.completed>0)&&(e="connected"),e!==t.iceConnectionState){t.iceConnectionState=e;var n=new Event("iceconnectionstatechange");this.dispatchEvent(n),null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange(n)}},window.RTCPeerConnection.prototype.createOffer=function(){var e=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");var t;1===arguments.length&&"function"!=typeof arguments[0]?t=arguments[0]:3===arguments.length&&(t=arguments[2]);var i=[],r=0,a=0;if(this.localStreams.length&&(r=this.localStreams[0].getAudioTracks().length,a=this.localStreams[0].getVideoTracks().length),t){if(t.mandatory||t.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==t.offerToReceiveAudio&&(r=t.offerToReceiveAudio),void 0!==t.offerToReceiveVideo&&(a=t.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(e){i.push({kind:e.kind,track:e,wantReceive:"audio"===e.kind?r>0:a>0}),"audio"===e.kind?r--:"video"===e.kind&&a--});r>0||a>0;)r>0&&(i.push({kind:"audio",wantReceive:!0}),r--),a>0&&(i.push({kind:"video",wantReceive:!0}),a--);var s=n.writeSessionBoilerplate(),o=[];i.forEach(function(t,i){var r=t.track,a=t.kind,s=n.generateIdentifier(),d=e.usingBundle&&i>0?{iceGatherer:o[0].iceGatherer,iceTransport:o[0].iceTransport,dtlsTransport:o[0].dtlsTransport}:e._createIceAndDtlsTransports(s,i),c=RTCRtpSender.getCapabilities(a);c.codecs=c.codecs.filter(function(e){return"rtx"!==e.name}),c.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1")});var u,h,l=[{ssrc:1001*(2*i+1)}];r&&(u=new RTCRtpSender(r,d.dtlsTransport)),t.wantReceive&&(h=new RTCRtpReceiver(d.dtlsTransport,a)),o[i]={iceGatherer:d.iceGatherer,iceTransport:d.iceTransport,dtlsTransport:d.dtlsTransport,localCapabilities:c,remoteCapabilities:null,rtpSender:u,rtpReceiver:h,kind:a,mid:s,sendEncodingParameters:l,recvEncodingParameters:null}}),this.usingBundle&&(s+="a=group:BUNDLE "+o.map(function(e){return e.mid}).join(" ")+"\r\n"),i.forEach(function(t,i){var r=o[i];s+=n.writeMediaSection(r,r.localCapabilities,"offer",e.localStreams[0])}),this._pendingOffer=o;var d=new RTCSessionDescription({type:"offer",sdp:s});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,d),Promise.resolve(d)},window.RTCPeerConnection.prototype.createAnswer=function(){var e=this,t=n.writeSessionBoilerplate();this.usingBundle&&(t+="a=group:BUNDLE "+this.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),this.transceivers.forEach(function(i){if(i.isDatachannel)return void(t+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+i.mid+"\r\n");var r=e._getCommonCapabilities(i.localCapabilities,i.remoteCapabilities);t+=n.writeMediaSection(i,r,"answer",e.localStreams[0])});var i=new RTCSessionDescription({type:"answer",sdp:t});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,i),Promise.resolve(i)},window.RTCPeerConnection.prototype.addIceCandidate=function(e){if(e){var t=e.sdpMLineIndex;if(e.sdpMid)for(var i=0;i<this.transceivers.length;i++)if(this.transceivers[i].mid===e.sdpMid){t=i;break}var r=this.transceivers[t];if(r){var a=Object.keys(e.candidate).length>0?n.parseCandidate(e.candidate):{};if("tcp"===a.protocol&&(0===a.port||9===a.port))return;if("1"!==a.component)return;r.iceTransport.addRemoteCandidate(a);var s=n.splitSections(this.remoteDescription.sdp);s[t+1]+=(a.type?e.candidate.trim():"a=end-of-candidates")+"\r\n",this.remoteDescription.sdp=s.join("")}}else for(var o=0;o<this.transceivers.length;o++)if(this.transceivers[o].iceTransport.addRemoteCandidate({}),this.usingBundle)return;return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.getStats=function(){var e=[];this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(i){t[i]&&e.push(t[i].getStats())})});var t=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1],i=function(e){return e.type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type,e};return new Promise(function(n){var r=new Map;Promise.all(e).then(function(e){e.forEach(function(e){Object.keys(e).forEach(function(t){e[t].type=i(e[t]),r.set(t,e[t])})}),t&&window.setTimeout(t,0,r),n(r)})})}}};t.exports={shimPeerConnection:a.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":10,"./getusermedia":6,sdp:1}],6:[function(e,t,i){t.exports=function(){var e=function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}},t=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(i){return t(i).catch(function(t){return Promise.reject(e(t))})}}},{}],7:[function(e,t,i){var n=e("../utils").browserDetails,r={shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var i=new Event("track");i.track=t,i.receiver={track:t},i.streams=[e.stream],this.dispatchEvent(i)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(){if("object"==typeof window&&(window.RTCPeerConnection||window.mozRTCPeerConnection)){window.RTCPeerConnection||(window.RTCPeerConnection=function(e,t){if(n.version<38&&e&&e.iceServers){for(var i=[],r=0;r<e.iceServers.length;r++){var a=e.iceServers[r];if(a.hasOwnProperty("urls"))for(var s=0;s<a.urls.length;s++){var o={url:a.urls[s]};0===a.urls[s].indexOf("turn")&&(o.username=a.username,o.credential=a.credential),i.push(o)}else i.push(e.iceServers[r])}e.iceServers=i}return new mozRTCPeerConnection(e,t)},window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype,mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}});var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var t=function(e){var t=new Map;return Object.keys(e).forEach(function(i){t.set(i,e[i]),t[i]=e[i]}),t},i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(e,a,s){return r.apply(this,[e||null]).then(function(e){return n.version<48&&(e=t(e)),n.version<53&&!a&&e.forEach(function(e){e.type=i[e.type]||e.type}),e}).then(a,s)}}}};t.exports={shimOnTrack:r.shimOnTrack,shimSourceObject:r.shimSourceObject,shimPeerConnection:r.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":10,"./getusermedia":8}],8:[function(e,t,i){var n=e("../utils").log,r=e("../utils").browserDetails;t.exports=function(){var e=function(e){return{name:{SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},t=function(t,i,a){var s=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var n=e[i]="object"==typeof e[i]?e[i]:{ideal:e[i]};if(void 0===n.min&&void 0===n.max&&void 0===n.exact||t.push(i),void 0!==n.exact&&("number"==typeof n.exact?n.min=n.max=n.exact:e[i]=n.exact,delete n.exact),void 0!==n.ideal){e.advanced=e.advanced||[];var r={};"number"==typeof n.ideal?r[i]={min:n.ideal,max:n.ideal}:r[i]=n.ideal,e.advanced.push(r),delete n.ideal,Object.keys(n).length||delete e[i]}}}),t.length&&(e.require=t),e};return t=JSON.parse(JSON.stringify(t)),r.version<38&&(n("spec: "+JSON.stringify(t)),t.audio&&(t.audio=s(t.audio)),t.video&&(t.video=s(t.video)),n("ff37: "+JSON.stringify(t))),navigator.mozGetUserMedia(t,i,function(t){a(e(t))})},i=function(e){return new Promise(function(i,n){t(e,i,n)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:i,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){
return new Promise(function(e){var t=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];e(t)})},r.version<41){var a=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return a().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(r.version<49){var s=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(t){return s(t).then(function(e){if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return e},function(t){return Promise.reject(e(t))})}}navigator.getUserMedia=function(e,i,n){return r.version<44?t(e,i,n):(console.warn("navigator.getUserMedia has been replaced by navigator.mediaDevices.getUserMedia"),void navigator.mediaDevices.getUserMedia(e).then(i,n))}}},{"../utils":10}],9:[function(e,t,i){var n={shimGetUserMedia:function(){navigator.getUserMedia=navigator.webkitGetUserMedia}};t.exports={shimGetUserMedia:n.shimGetUserMedia}},{}],10:[function(e,t,i){var n=!0,r={disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(n=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},log:function(){if("object"==typeof window){if(n)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},extractVersion:function(e,t,i){var n=e.match(t);return n&&n.length>=i&&parseInt(n[i],10)},detectBrowser:function(){var e={};if(e.browser=null,e.version=null,"undefined"==typeof window||!window.navigator)return e.browser="Not a browser.",e;if(navigator.mozGetUserMedia)e.browser="firefox",e.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)e.browser="chrome",e.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return e.browser="Not a supported browser.",e;e.browser="edge",e.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return e},shimCreateObjectURL:function(){var e=URL.createObjectURL.bind(URL),t=URL.revokeObjectURL.bind(URL),i=new Map,n=0;URL.createObjectURL=function(t){if("getTracks"in t){var r="polyblob:"+ ++n;return i.set(r,t),console.log("URL.createObjectURL(stream) is deprecated! Use elem.srcObject = stream instead!"),r}return e(t)},URL.revokeObjectURL=function(e){t(e),i.delete(e)};var r=Object.getOwnPropertyDescriptor(window.HTMLMediaElement.prototype,"src");Object.defineProperty(window.HTMLMediaElement.prototype,"src",{get:function(){return r.get.apply(this)},set:function(e){return this.srcObject=i.get(e)||null,r.set.apply(this,[e])}})}};t.exports={log:r.log,disableLog:r.disableLog,browserDetails:r.detectBrowser(),extractVersion:r.extractVersion,shimCreateObjectURL:r.shimCreateObjectURL}},{}]},{},[2])(2)}),define("nano.peerconnectionclient",["nano.sdputilwrapper","EventEmitter","nano.tools","adapter"],function(e,t,i,n){"use strict";function r(e,i){t.call(this),s("Creating RTCPeerConnnection with:\n  config: '"+u(e.peerConnectionConfig)+"';\n  constraints: '"+u(e.peerConnectionConstraints)+"'."),this._params=e,this._startTime=i,this._pc=null,this._hasRemoteSdp=!1,this._messageQueue=[],this._isInitiator=!1,this._started=!1,this._passThrough=!1,this.create()}var a,s=i.debug_,o=i.error_,d=i.success_,c=i.parseJSON,u=i.stringifyJSON,h=r.prototype=Object.create(t.prototype);return h.isStarted=function(){return this._started},h.isInitiator=function(){return this._isInitiator},h._reset=function(){this._pc=null,this._hasRemoteSdp=!1,this._messageQueue=[],this._isInitiator=!1,this._started=!1,this._passThrough=!1},h.create=function(){this.close();try{this._pc=new RTCPeerConnection(this._params.peerConnectionConfig,this._params.peerConnectionConstraints),this._pc.onicecandidate=this._onIceCandidate.bind(this),this._pc.ontrack=this._onRemoteStreamAdded.bind(this),this._pc.onremovestream=this._onRemoteStreamRemoved.bind(this),this._pc.onsignalingstatechange=this._onSignalingStateChanged.bind(this),this._pc.oniceconnectionstatechange=this._onIceConnectionStateChanged.bind(this),this._pc.onnegotiationneeded=this._onNegotiationNeeded.bind(this),d("Peer connection created"),this.emitSimple("PeerConnectionCreated")}catch(e){this._onError("CreatePeerConnection",e)}},h.close=function(){this._pc&&(this._pc.close(),this._reset(),d("Peer connection closed"),this.emitSimple("PeerConnectionClosed"))},h.addStream=function(e){this._pc&&this._pc.addStream(e)},h.removeStream=function(e){if(this._pc)try{this._pc.removeStream(e)}catch(e){o(e.message)}},h.startAsCaller=function(e){if(this._pc&&!this._started){this._isInitiator=!0,this._started=!0;var t=this._buildConstraints(e);s("Sending offer to peer with constraints: \n'"+u(t)+"'.");var i=this;this._pc.createOffer(t).then(function(e){i._setLocalSdpAndNotify(e)}).catch(function(e){i._onError("createAnswer",e)})}},h.startAsCallee=function(e){if(this._pc&&!this._started)if(this._isInitiator=!1,this._started=!0,e&&e.length>0)for(var t=0,i=e.length;t<i;t++)this.receiveSignalingMessage(e[t]);else this._messageQueue.length>0&&this._drainMessageQueue()},h.receiveSignalingMessage=function(e){var t=c(e);if(t){if((this._isInitiator||this._passThrough)&&"answer"===t.type||(!this._isInitiator||this._passThrough)&&"offer"===t.type)this._hasRemoteSdp=!0,this._messageQueue.unshift(t);else if(t.candidate)this._messageQueue.push(t);else if("bye"===t.type)this.emitSimple("RemoteHangUp"),this._started=!1;else if(t.rtmp)return t.text=t.message,t.status&&t.number||(t.status="unknown",t.number=0),void this.emitSimple("ReceivedRtmpStatus",t);this._drainMessageQueue()}},h.getStats=function(e){if(this._pc)return this._pc.getStats(e)},h._doAnswer=function(){var e=this._buildConstraints();s("Sending answer to peer with constraints: "+u(e,null," "));var t=this;this._pc.createAnswer(e).then(function(e){t._setLocalSdpAndNotify(e)}).catch(function(e){t._onError("createAnswer",e)})},h._modifySDPFirefoxAnswer=function(e){if("Firefox"===i.browserInfo.browser&&e.indexOf("a=msid-semantic:WMS *")>0){var t,n=e.split("\r\n"),r="",a=-1,o="";["video","audio"].forEach(function(e){for(t=0,o="";t<n.length;t++)if(o){if(0===n[t].indexOf("a=ssrc:")){var i=n[t].split(":")[1].split(" ")[0];n.splice(t+1,0,"a=ssrc:"+i+" msid:"+r+" "+o,"a=ssrc:"+i+" mslabel:default","a=ssrc:"+i+" label:"+o);break}if(0===n[t].indexOf("a=mid:"))break}else if(0===n[t].indexOf("a=msid:")&&t>0&&0===n[t-1].indexOf("a=mid:"+e)){var s=n[t].split(":")[1].split(" ");r=s[0],o=s[1],a=!0}}),e=n.join("\r\n"),s("Parsed answer SDP for firefox")}return e},h._setLocalSdpAndNotify=function(e){try{e.sdp=this._replaceSendReceive(e.sdp,this._params.send,this._params.receive),e.sdp=maybePreferVideoReceiveCodec(e.sdp,this._params),e.sdp=this._modifySDPFirefoxAnswer(e.sdp)}catch(e){s("_setLocalSdpAndNotify: error: "+e)}var t=this;this._pc.setLocalDescription(e).then(function(){s("Set session description success.")}).catch(function(e){t._onError("setLocalDescription",e)}),this.emitSimple("SignalingMessage",{sdp:e.sdp,type:e.type})},h._buildConstraints=function(e){return"Firefox"===i.browserInfo.browser?{offerToReceiveAudio:!0,offerToReceiveVideo:!0}:mergeConstraints(e,a)},h._setRemoteSdp=function(e){e.sdp=maybePreferVideoReceiveCodec(e.sdp,this._params),e.sdp=maybePreferVideoSendCodec(e.sdp,this._params),this._params.videoSendBitrate&&(e.sdp=maybeSetVideoSendBitRate(e.sdp,this._params)),this._params.videoSendInitialBitrate&&(e.sdp=maybeSetVideoSendInitialBitRate(e.sdp,this._params)),this._pc.setRemoteDescription(new RTCSessionDescription(e)).then(this._onSetRemoteDescriptionSuccess.bind(this)).catch(this._onError.bind(this,"setRemoteDescription"))},h._onSetRemoteDescriptionSuccess=function(){var e=this._pc.getRemoteStreams(),t=e.length>0&&e[0].getVideoTracks().length>0;s("Set remote session description success"),this.emitSimple("RemoteSDPSet",{hasremotetrack:t,remotestreams:e})},h._drainMessageQueue=function(){if(this._pc&&this._started&&this._hasRemoteSdp){for(var e=0,t=this._messageQueue.length;e<t;e++)this._processSignalingMessage(this._messageQueue[e]);this._messageQueue=[]}},h._processSignalingMessage=function(e){if(s("MSG:"),s(e),"offer"!==e.type||this._isInitiator&&!this._passThrough)if("answer"===e.type&&(this._isInitiator||this._passThrough)){if("have-local-offer"!==this._pc.signalingState)return void s("MSG: ERROR: remote answer received in unexpected state: "+this._pc.signalingState);this._setRemoteSdp(e)}else if(e.candidate||"candidate"===e.type){s("MSG: new ice candidate");var t=new RTCIceCandidate({sdpMLineIndex:e.sdpMLineIndex,sdpMid:e.sdpMid,candidate:e.candidate});this._recordIceCandidate("Remote",t);var i=this;this._pc.addIceCandidate(t).then(function(){s("MSG: Remote candidate added successfully.")}).catch(function(e){i._onError("addIceCandidate",e)})}else s("WARNING: MSG: unexpected message: "+u(e));else{if(s("MSG: new ice offer"),"stable"!==this._pc.signalingState)return void s("ERROR: remote offer received in unexpected state: "+this._pc.signalingState);this._setRemoteSdp(e),this._doAnswer()}},h._onIceCandidate=function(e){var t=e.candidate;return t?void(this._isValidIceCandidate(t)&&(this.emitSimple("SignalingMessage",{sdpMLineIndex:t.sdpMLineIndex,sdpMid:t.sdpMid,candidate:t.candidate}),this._recordIceCandidate("Local",t))):void s("End of candidates.")},h._isValidIceCandidate=function(e){var t=e.candidate;return t.indexOf("tcp")===-1&&("relay"!==this._params.peerConnectionConfig.iceTransports||"relay"===iceCandidateType(t))},h._onSignalingStateChanged=function(){this._pc&&(s("Signaling state changed to: "+this._pc.signalingState),this.emitSimple("SignalingStateChanged",{state:this._pc.signalingState}))},h._onIceConnectionStateChanged=function(){this._pc&&("completed"===this._pc.iceConnectionState&&s("ICE complete time: "+(window.performance.now()-this._startTime).toFixed(0)+"ms."),s("ICE connection state changed to: "+this._pc.iceConnectionState),this.emitSimple("IceConnectionStateChange",{state:this._pc.iceConnectionState}))},h._onNegotiationNeeded=function(e){this._pc&&(s("NegotiationNeeded Event"),this.emitSimple("NegotiationNeeded",e))},h._recordIceCandidate=function(e,t){s("New ICE candidate for "+e),this.emitSimple("NewIceCandidate",{location:e,candidate:t})},h._onRemoteStreamAdded=function(e){s("Remote stream added to peer connection"),this.emitSimple("RemoteStreamAdded",{stream:e.streams[0]})},h._onRemoteStreamRemoved=function(e){s("Remote stream removed from peer connection"),this.emitSimple("RemoteStreamRemoved",{stream:e.stream})},h._onError=function(e,t){o('Error in "'+e+'": '+t.toString()),this.emitSimple("PeerConnectionError",{tag:e,error:t.toString()})},h._replaceSendReceive=function(e,t,i){var n="";t&&i?n="a=sendrecv":t?n="a=sendonly":i&&(n="a=recvonly");for(var r,a=e.split("\r\n"),s=0,o=a.length;s<o;s++)r=a[s],r.indexOf("a=sendrecv")===-1&&r.indexOf("a=sendonly")===-1&&r.indexOf("a=recvonly")===-1||(a[s]=n);return a.join("\r\n")},r}),define("nano.channelmember",["nano.hangingget","nano.peerconnectionclient","nano.const","EventEmitter","nano.tools"],function(e,t,i,n,r){"use strict";function a(e,t,r,a,s,o,c,u,p){n.call(this),h(e)||d("ChannelMember: param server must be a string",2),h(t)||d("ChannelMember: param userName must be a string",2),h(a)||d("ChannelMember: param room must be a string",2),l(s)||d("ChannelMember: param role must be an integer",2),m(r)||d("ChannelMember: param userId must be an integer",2),o&&!h(o)&&d("ChannelMember: param serverUserName must be a string",2),c&&!h(c)&&d("ChannelMember: param serverUserName must be a string",2),u&&!h(u)&&d("ChannelMember: param serverPassword must be a string",2),p&&!h(p)&&d("ChannelMember: param serverPassword must be a string",2),this._server=e,this._userName=t,this._userId=r,this._peerId=void 0,this._remotePeerId=void 0,this._remoteUserId=void 0,this._remoteUserName=void 0,this._room=a,this._role=s,0===s&&(this._remoteUserId=r,this._remoteUserName="webrtc2H264"),this._serverUserName=c,this._serverPassword=u,this._token=o,this._bintuApiKey=p,this._hangingGet=void 0,this._pcClient=void 0,this._streams=[],this._transcodingSettings={output:null,streamname:null,videobitrate:null,videowidth:null,videoheight:null,audiobitrate:null,framerate:null,mirror:null,dropframes:null,h264passthrough:null,icecast_audio:null,output2:null,videobitrate2:null,audiobitrate2:null,framerate2:null,rtmpconnectinfo:null},this._startTime=null,this._iceServers=[],this._config={},this._state=void 0,this._setState(i.CHANNEL_IDLE),this._handshakeState=void 0,this._setHandshakeState(i.HANDSHAKE_IDLE),this._messageQueue=[],this._remoteStream=null,this._callActive=!1,this._statsEnabled=!1,this._statsIntervalTime=1e3,this._statsInterval=0}var s=r.debug_,o=r.warning_,d=r.error_,c=r.success_,u=r.shortenText,h=r.isString,l=r.isInt,m=r.isIntString,p=r.parseJSON,f=r.stringifyJSON,_=r.isObject,v=r.isArray,g=r.encodeURIComponent,S=a.prototype=Object.create(n.prototype);return S.sendMetaData=function(e,t){this.getState()===i.CHANNEL_CALL_ACTIVE?(s("[CM "+this._peerId+"] sending metaData: "+e+" - "+f(t)),this._sendMessageToPeer(this._remotePeerId,{eventType:"metaData",eventName:e,strLabel:this._streams[0].id,payload:t})):d("[CM "+this._peerId+"]Tried to send metaData but channelmember is not in active state")},S.setName=function(e){this._userName=e},S.setRoom=function(e){this._room=e},S.setRemoteUserName=function(e){this._remoteUserName=e},S.setRemoteUserId=function(e){this._remoteUserId=e},S.setIceServers=function(e){this._iceServers=e},S.setConfig=function(e){this._config=e},S.getRemotePeerId=function(){return this._remotePeerId},S.getRemoteUserName=function(){return this._remoteUserName},S.getRemoteUserId=function(){return this._remoteUserId},S.getState=function(){return this._state},S.getRole=function(){return this._role},S.getStreams=function(){return this._streams},S.getPeerId=function(){return this._peerId},S.getRoom=function(){return this._room},S.setTranscodingSettings=function(e){this._role!==i.ROLE_BROADCASTER&&o("[CM "+this._peerId+"] you are setting a transcode-target but role is not 0 (it is "+this._role+")");for(var t in e)this._transcodingSettings.hasOwnProperty(t)&&(this._transcodingSettings[t]=e[t])},S._getSignInParams=function(){var e="peer="+this._userId+"_"+this._userName+"_room_"+this._room+"&unique="+this._userId+"&room="+this._room+"&role="+this._role+(this._token?"&token="+this._token:"")+(this._serverUserName?"&username="+this._serverUserName:"")+(this._serverPassword?"&password="+this._serverPassword:"")+(this._bintuApiKey?"&bintu_api_key="+this._bintuApiKey:"");return e},S._getBroadcasterSignInParams=function(){var e="";for(var t in this._transcodingSettings){var i=this._transcodingSettings[t];null!==i&&((_(i)||h(i))&&(i=g(f(i))),e+="&"+t.toString()+"="+i)}return e+=this._streams[0]&&this._streams[0].id?"&stream_label="+this._streams[0].id:"",e+=this._streams[1]&&this._streams[1].id?"&stream_label2="+this._streams[1].id:"",e+=this._config.codecs.videoCodec?"&videocodec="+this._config.codecs.videoCodec:"VP8",this._streams.length>0&&(e+=this._streams[0].getAudioTracks().length>0?"&audio=1":"&audio=0",e+=this._streams[0].getVideoTracks().length>0?"&video=1":"&video=0"),e},S.signIn=function(e,t){try{var n=this,r=new XMLHttpRequest;r.withCredentials=!0;var a=0;r.onprogress=function(e){var t="";e.lengthComputable&&(t=e.loaded+"/"+e.total,s("SignIn [CM "+n._peerId+"] : XHR progress. "+t))},r.onloadstart=function(e){s("SignIn [CM "+n._peerId+"] : XHR loadstart")},r.onloadend=function(e){s("SignIn [CM "+n._peerId+"] : XHR loadend")},r.onerror=function(e){d("SignIn [CM "+n._peerId+"] : XHR error."),n._emitRequestEvent(r,"SignInError","maybe network or server issue!")},r.onabort=function(e){d("SignIn [CM "+n._peerId+"] : XHR aborted."),n._emitRequestEvent(r,"SignInError","Request aborted!")},r.onreadystatechange=function(e){if(0===r.status&&(a++,a<2&&s("SignIn [CM "+n._peerId+"] : http status 0 (unsent) - ok."),a>1&&(o("SignIn [CM "+n._peerId+"] : Server not (yet) up or wrong params passed"),n._emitRequestEvent(r,"SignInError","Server not (yet) up or wrong params passed"))),4===r.readyState)if(403===r.status)d("SignIn [CM "+n._peerId+"] : SignIn Error "+r.status+": "+r.responseText),n._emitRequestEvent(r,"SignInError");else if(509===r.status)r.abort(),n._role===i.ROLE_BROADCASTER?(d("SignIn [CM "+n._peerId+"] : SignIn Error "+r.status+": Could not start broadcast: too many active broadcasts on server."),n._emitRequestEvent(r,"SignInError","Too many active broadcasts on server")):(d("SignIn [CM "+n._peerId+"] : SignIn Error "+r.status+": unknown cause."),n._emitRequestEvent(r,"SignInError"));else if(200===r.status)n._peerId=parseInt(e.currentTarget.response.split(",")[1],10),n._setState(i.CHANNEL_SIGNED_IN),n._initializePeerList(e.currentTarget.response),n._startHangingGet(),c("SignIn [CM "+n._peerId+"] : SignInSuccess"),n.emitSimple("SignInSuccess",{request:r,server:n._server,status:e.currentTarget.status});else{var t="Connect failed for unknown reason";d("SignIn [CM "+n._peerId+"] : SignIn Error "+r.status+": "+t),r.responseText.length>0&&(t=r.responseText,d("[CM "+n._peerId+"] "+t)),n._emitRequestEvent(r,"SignInError",t)}};var u=this._server+"/sign_in?"+n._getSignInParams();this._role===i.ROLE_BROADCASTER&&this._streams.length>0&&(u+=n._getBroadcasterSignInParams()),s("SignIn [CM "+n._peerId+"] : GET: "+u),r.open("GET",u,!0),r.send()}catch(e){d("SignIn [CM "+n._peerId+"] : SignInRequest failed - "+e.message),this._emitRequestEvent(r,"SignInError",e.message)}},S.signOut=function(e){this._setState(i.CHANNEL_IDLE),this._closePCClient(),this._hangingGet&&this._hangingGet.abort();try{var t=new XMLHttpRequest;t.withCredentials=!0;var n=0,r=this;t.onprogress=function(e){var t="";e.lengthComputable&&(t=e.loaded+"/"+e.total,s("SignOut [CM "+r._peerId+"] : XHR progress. "+t))},t.onloadstart=function(e){s("SignOut [CM "+r._peerId+"] : XHR loadstart")},t.onloadend=function(e){s("SignOut [CM "+r._peerId+"] : XHR loadend")},t.onerror=function(e){d("SignOut [CM "+r._peerId+"] : XHR error."),r._emitRequestEvent(t,"SignOutError","maybe network or server issue!")},t.onabort=function(e){d("SignOut [CM "+r._peerId+"] : XHR aborted."),r._emitRequestEvent(t,"SignOutError","Request aborted!")},t.onreadystatechange=function(){if(s("SignOut [CM "+r._peerId+"] : XHR Connect state: "+t.status+", "+t.readyState+", "+u(t.responseText)),0===t.status){if(n++,n<2&&s("SignOut [CM "+r._peerId+"] : http status 0 (unsent) - ok."),n>1)return o("SignOut [CM "+r._peerId+"] : Server not (yet) up or wrong params passed"),void r._emitRequestEvent(t,"SignOutError","Server not (yet) up or wrong params passed")}else if(4===t.readyState)if(200===t.status)c("SignOut [CM "+r._peerId+"] : Signed out from server"),r._emitRequestEvent(t,"SignOutSuccess");else if(410===t.status)o("SignOut [CM "+r._peerId+"] : Signed out, but peerserver is disconnected"),r._emitRequestEvent(t,"SignOutSuccess");else{var e="Disconnect failed for unknown reason";d("SignOut [CM "+r._peerId+"] : SignOut Error "+t.status+": "+e),t.responseText.length>0&&(e=t.responseText,d(e)),r._emitRequestEvent(t,"SignOutError",e)}};var a=!e;t.open("GET",this._server+"/sign_out?peer_id="+this._peerId,a),t.send()}catch(e){d("SignOut [CM "+r._peerId+"] : SignOutRequest failed - "+e.message),this._emitRequestEvent(t,"SignOutError",e.message)}finally{this._setState(i.CHANNEL_IDLE)}},S._addEventPayload=function(e){return e=e||{},e.target=this,e.data=e.data||{},e.data.remoteUserName=this._remoteUserName,e.data.remoteUserId=this._remoteUserId,e},S._emitRequestEvent=function(e,t,i){this.emitSimple(t,{request:e,server:this._server,status:e.status,text:i||e.responseText})},S.enableStats=function(e,t){this._statsEnabled="undefined"==typeof e||e,this._statsIntervalTime=t||1e3},S.preparePeerConnection=function(){this._pcClient||this._createPCClient()},S.invokeCall=function(e){if(this._handshakeState!==i.HANDSHAKE_DONE){if(!l(e))return void d("[CM "+this._peerId+"] remotePeerId must be set and must be an integer!");if(this._state>i.CHANNEL_HANDSHAKE)return o("[CM "+this._peerId+"] invokeCall: state should be SIGNED_IN or HANDSHAKE --> return"),void this._reportState();this._reportState(),this._remotePeerId=e,this._handshakeState===i.HANDSHAKE_IDLE?this._doHandshake():o("[CM "+this._peerId+"] invokeCall: we are still doing an handshake --> return!")}},S._doHandshake=function(){this._setState(i.CHANNEL_HANDSHAKE),this._setHandshakeState(i.HANDSHAKE_CALLYOU),this._onSignalingMessage({data:{type:"callyou"}}),this.emitSimple("GetBusy"),this.emitSimple("Handshake",{remotePeerId:this._remotePeerId},this)},S.doCall=function(){this._handshakeState===i.HANDSHAKE_CALLYOU&&(this._setHandshakeState(i.HANDSHAKE_DONE),this.preparePeerConnection(),this._pcClient.startAsCaller(null),this._setState(i.CHANNEL_CALLING))},S.answerCall=function(){return this._remotePeerId?this._state!==i.CHANNEL_CALL_INCOMING?(this._reportState(),void o("[CM "+this._peerId+"] answerCall: No call incoming!")):(this._reportState(),this.preparePeerConnection(),this._pcClient.startAsCallee(this._messageQueue),void this._setState(i.CHANNEL_CALL_NEGOTIATING)):void d("[CM "+this._peerId+"] No remote peer set!")},S._getPeerConnectionConfig=function(){var e={iceServers:this._iceServers,iceTransports:"all"},t={optional:[],mandatory:[]};t.optional.push({googCpuOveruseDetection:!1}),t.optional.push({RtpDataChannels:!1});var n={mediaConstraints:{audio:!0,video:!0},peerConnectionConfig:e,peerConnectionConstraints:t,send:0!==this._streams.length,receive:this._role!==i.ROLE_BROADCASTER,videoSendCodec:this._config.codecs.videoCodec||"VP8",videoRecvCodec:this._config.codecs.videoCodec||"VP8",videoSendBitrate:this._config.bitrates.videoSendBitrate||0,videoSendInitialBitrate:this._config.bitrates.videoSendInitialBitrate||0};return n},S._createPCClient=function(){if(this._pcClient)return void s("[CM "+this._peerId+"] PeerConnection still alive, do not create!");try{this._pcClient=new t(this._getPeerConnectionConfig(),this._startTime),this._pcClient.on("ReceivedRtmpStatus",this._reemit.bind(this)),this._pcClient.on("SignalingStateChanged",this._onSignalingStateChanged.bind(this)),this._pcClient.on("SignalingMessage",this._onSignalingMessage.bind(this)),this._pcClient.on("PeerConnectionCreated",this._reemit.bind(this)),this._pcClient.on("PeerConnectionClosed",this._reemit.bind(this)),this._pcClient.on("PeerConnectionError",this._reemit.bind(this)),this._pcClient.on("RemoteSDPSet",this._reemit.bind(this)),this._pcClient.on("RemoteStreamRemoved",this._onRemoteStreamRemoved.bind(this)),this._pcClient.on("RemoteStreamAdded",this._onRemoteStreamAdded.bind(this)),this._pcClient.on("RemoteHangUp",this._onRemoteHangUp.bind(this)),this._pcClient.on("NewIceCandidate",this._reemit.bind(this)),this._pcClient.on("IceConnectionStateChange",this._onIceConnectionStateChange.bind(this)),this._pcClient.on("NegotiationNeeded",this._onNegotiationNeeded.bind(this));for(var e=0;e<this._streams.length;e++)this._pcClient.addStream(this._streams[e]);c("Created PeerConnectionClient"),this.emitSimple("CreatePeerConnectionClientSuccess",{streams:this._streams})}catch(e){d("[CM "+this._peerId+"] Create PeerConnection exception: "+e.message),this.emitSimple("CreatePeerConnectionClientError")}},S._setState=function(e){var t=this._state;this._state=e,this._reportState(!0,t),this.emitSimple("CallState",{state:this._state},this)},S._reportState=function(e,t){var n=e&&this._state!==t?t?"changed state ":"set state ":"report state ";for(var r in i)if(r.indexOf("CHANNEL_")!==-1&&i[r]===this._state){if(e)for(var a in i)a.indexOf("CHANNEL_")!==-1&&i[a]===t&&(n+='from "'+a+'" to "');s("[CM "+this._peerId+"] "+this._buildStateText(n,r));break}},S._setHandshakeState=function(e){this._handshakeState=e;var t="set handshake state ";for(var n in i)if(n.indexOf("HANDSHAKE_")!==-1&&i[n]===this._handshakeState){s("[CM "+this._peerId+"] "+this._buildStateText(t,n));break}},S._buildStateText=function(e,t){return e+='"'+t+'": (we:',e+=this._userName?" "+this._userName:" ",e+=this._userId?" "+this._userId:" ",e+=this._peerId?" "+this._peerId:" ",e+=")",(this._state>2||this._remotePeerId)&&(e+=" with (remote:",e+=this._remoteUserName?" "+this._remoteUserName:" ",e+=this._remoteUserId?" "+this._remoteUserId:" ",e+=this._remotePeerId?" "+this._remotePeerId:" ",e+=")"),e},S._reemit=function(e){e=this._addEventPayload(e),this.emit(e.name,e)},S._onSignalingStateChanged=function(e){s("[CM "+this._peerId+"] sigstate: "+e.data.state),e=this._addEventPayload(e),this.emit(e.name,e)},S._onIceConnectionStateChange=function(e){switch(e=this._addEventPayload(e),e.data.state){case"new":break;case"checking":break;case"connected":this._setCallActive(e);break;case"completed":this._setCallActive(e);break;case"failed":this._setState(i.CHANNEL_CALL_DROPPED),e.name="CallDropped",this.emit(e.name,e);break;case"disconnected":this._setState(i.CHANNEL_CALL_UNSTABLE),e.name="CallUnstable",this.emit(e.name,e);break;case"closed":}},S._onNegotiationNeeded=function(e){this.emit(e.name,e)},S._onRemoteStreamAdded=function(e){this._remoteStream=e.data.stream},S._onRemoteStreamRemoved=function(e){this._remoteStream=null},S._setCallActive=function(e){if(this._state!==i.CHANNEL_CALL_ACTIVE){if(this._callActive)return this._setState(i.CHANNEL_CALL_ACTIVE),e.name="CallAgainStable",void this.emit(e.name,e);if(this._setState(i.CHANNEL_CALL_ACTIVE),this._callActive=!0,(navigator.mozGetUserMedia||navigator.webkitGetUserMedia)&&this._statsEnabled&&this._pcClient){var t=this;clearInterval(t._statsInterval),this._statsInterval=setInterval(function(){return t._pcClient?void t._pcClient.getStats().then(function(e){t.emitSimple("ReceivedWebRTCStats",{report:e,results:{},remoteUserName:t._remoteUserName,remoteUserId:t._remoteUserId})}).catch(function(e){d("[CM "+t._peerId+"] "+e)}):void clearInterval(t._statsInterval)},this._statsIntervalTime)}this.emitSimple("CallActive",{remoteUserName:this._remoteUserName,remoteUserId:this._remoteUserId},this),null!==this._remoteStream&&(e.name="RemoteStreamAdded",e.data.stream=this._remoteStream,this.emit(e.name,e))}},S._closePCClient=function(){if(this._pcClient){for(var e in this._streams)this._pcClient.removeStream(this._streams[e]);this._pcClient.close(),this._pcClient=null}},S.addStream=function(e){return e?2===this._streams.length?void o("[CM "+this._peerId+"] stream count is already=2, we only support 2 streams/ChannelMember"):void(v(e)?this._streams=e:this._streams.push(e)):void d("[CM "+this._peerId+'] parameter "stream" must not be undefined')},S.removeStreams=function(){for(var e in this._streams)this._streams[e]=null;this._streams=[]},S._initializePeerList=function(e){if(this._role!==i.ROLE_BROADCASTER){var t=[],n=e.split("\n");if(1===n.length)return null;for(var r,a=0;a<n.length;a++)0!==n[a].length&&(r=n[a].split(","),t.push({id:parseInt(r[1],10),name:r[0]}));this.emitSimple("PeerListUpdated",{userlist:t},this)}},S._updatePeerEntry=function(e,t,n){this._state===i.CHANNEL_SIGNED_IN&&this.emitSimple("PeerEntryUpdated",{remotePeerName:e,remotePeerId:t,connected:n},this)},S._parseReceivedServerNotification=function(e,t,i){return this._peerId===t?void o("[CM "+this._peerId+"] handleServerConnect: cannot connect to myself "+e+", id "+t):(this._reportState(),t===this._remotePeerId&&0===i&&(o("[CM "+this._peerId+"] Our remote peer "+this._remotePeerId+" ("+this._remoteUserName+" "+this._remoteUserId+") is disconnected"),this.emitSimple("RemotePeerDisconnected",{remoteUserName:this._remoteUserName,remoteUserId:this._remoteUserId},this)),void this._updatePeerEntry(e,t,i))},S._onReceivedServerNotification=function(e){410===e.data.status&&(e.data.response=""+this.getRemoteUserId()+"_"+this.getRemoteUserName()+"_room_"+this.getRoom()+","+this.getRemotePeerId()+",0");var t=e.data.response;s("[CM "+this._peerId+"] Message from server: "+t);var i=t.split(","),n=i[0],r=parseInt(i[1],10),a=parseInt(i[2],10);this._parseReceivedServerNotification(n,r,a)},S._startHangingGet=function(t,i){this._startTime=window.performance.now(),this._hangingGet=new e(this._server,this._peerId),this._hangingGet.on("HangingGetServerStatus",this._onHangingGetServerStatus.bind(this)),this._hangingGet.on("ReceivedServerMessage",this._onReceivedServerMessage.bind(this)),this._hangingGet.on("ReceivedServerNotification",this._onReceivedServerNotification.bind(this)),this._hangingGet.on("HangingGetError",this._onHangingGetError.bind(this)),this._hangingGet.start()},S._onHangingGetError=function(e){e=this._addEventPayload(e),s("[MSG CM "+this._peerId+"] HangingGet error!"),this.emit(e.name,e)},S._onHangingGetServerStatus=function(e){e=this._addEventPayload(e),s("[MSG CM "+this._peerId+"] HangingGet Server Status changed!"),this.emit(e.name,e)},S._onReceivedServerMessage=function(e){if(this._state!==i.CHANNEL_CALL_REJECTED){var t=e.data.peerId,n=e.data.response;if(isNaN(t)||0===t)return void o("[MSG CM "+this._peerId+"] Invalid Message (no peerid): "+n);if(s("[MSG CM "+this._peerId+"] from "+t+(this._debug?": "+n:"")),this._remotePeerId&&t!==this._remotePeerId)return s("[MSG CM "+this._peerId+"] from "+t+(this._debug?": "+n:"")+", but its not our remote!"),void this._onSignalingMessage({data:{type:"callbusy",otherId:t}});switch(this._remotePeerId||this.emitSimple("GetBusy"),s("[CM "+this._peerId+"] "+n),n=p(n),n.userId&&(this._remoteUserId=n.userId),n.userName&&(this._remoteUserName=n.userName),this._remotePeerId=n.peerId||t,n.type){case"callbusy":this._setState(i.CHANNEL_CALL_REJECTED);var e=this._addEventPayload();return e.name="CallRejected",void this.emit(e.name,e);case"callyou":if(this._state>i.CHANNEL_HANDSHAKE)break;this._setState(i.CHANNEL_HANDSHAKE),this._remotePeerId=t;var a=this._handshakeState!==i.HANDSHAKE_IDLE&&this._remotePeerId<this._peerId,d="Firefox"===n.agent&&"Firefox"!==r.browserInfo.browser;if(a||d){this._setHandshakeState(i.HANDSHAKE_CALLYOU);var e=this._addEventPayload();e.name="CallHandshakeWon",e.data.remotePeerId=this._remotePeerId,this.emit(e.name,e)}else this._setHandshakeState(i.HANDSHAKE_CALLME),this._onSignalingMessage({data:{type:"callme"}});return;case"callme":if(this._state>i.CHANNEL_HANDSHAKE)break;if(this._handshakeState!==i.HANDSHAKE_DONE){this._setState(i.CHANNEL_HANDSHAKE),this._setHandshakeState(i.HANDSHAKE_CALLYOU),this._remotePeerId=t;var e=this._addEventPayload();e.name="CallHandshakeWon",e.data.remotePeerId=this._remotePeerId,this.emit(e.name,e)}return}if(this._state<=i.CHANNEL_HANDSHAKE)return s("[CM "+this._peerId+"] We are being called!"),this._messageQueue.push(n),this._setState(i.CHANNEL_CALL_INCOMING),void this.emitSimple("CallIncoming",{remoteUserName:this._remoteUserName,remoteUserId:this._remoteUserId},this);if(this._state===i.CHANNEL_CALL_INCOMING)return s("[CM "+this._peerId+"] We have an incoming call and answer now!"),this._messageQueue.push(n),void this._reportState();if(this._state===i.CHANNEL_CALLING){if("offer"===n.type)return void o("[CM "+this._peerId+"] We have an offer, but we should receive an answer!");s("We are calling and the other side answer us!"),this._setState(i.CHANNEL_CALL_NEGOTIATING)}this._pcClient&&this._pcClient.receiveSignalingMessage(n)}},S._restartHangingGet=function(){this._hangingGet.restart()},S._sendMessageToPeer=function(e,t){var i=this._server+"/message?peer_id="+this._peerId+"&to="+e,n=new XMLHttpRequest;n.withCredentials=!0,n.open("POST",i,!0),
n.setRequestHeader("Content-Type","text/plain");var r=f(t);s("[MSG CM "+this._peerId+"] -> peer "+e+": "+r),n.send(r)},S._onSignalingMessage=function(e){if(!this._remotePeerId)return void d("[CM "+this._peerId+"] Try to send message, but no remote peer set! This should not happen!");e.data.agent=r.browserInfo.browser,e.data.userName=this._userName,e.data.userId=this._userId,e.data.peerId=this._peerId;var t=e.data.otherId||this._remotePeerId;this._sendMessageToPeer(t,e.data)},S._onRemoteHangUp=function(){this.emitSimple("RemoteHangup",{remotePeerID:this._remotePeerId,remotePeerName:this._remoteUserName}),this._closePCClient(),this._restartHangingGet()},a}),define("nano.rtcuser",["nano.mediacontroller","nano.userlist","nano.channelmemberlist","nano.channelmember","nano.const","nano.tools","EventEmitter"],function(e,t,i,n,r,a,s){"use strict";function o(){s.call(this),this._server=void 0,this._userName=void 0,this._userId=Math.round(1e9*Math.random()).toString(),this._room=void 0,this._serverUserName=void 0,this._serverPassword=void 0,this._token=void 0,this._bintuApiKey=void 0,this._iceServers=[{urls:["turn:turn.nanocosmos.net:80?transport=udp"],username:"nano",credential:"nano"},{urls:["turn:turn.nanocosmos.net:80?transport=tcp"],username:"nano",credential:"nano"}],this._optionalConfig={codecs:{videoCodec:"VP8"},bitrates:{videoSendInitialBitrate:0,videoSendBitrate:0}},this._streamProtected=!1,this._statsEnabled=!1,this._statsIntervalTime=1e3,this._isSignedIn=!1,this._isBroadcasting=!1,this._mediaController=new e,this._userList=new t(this._userId),this._channels=new i,o.checkSupport()}var d=a.getElement,c=a.debug_,u=a.warning_,h=a.error_,l=a.parseJSON,m=a.isObject,p=a.isString,f=o.prototype=Object.create(s.prototype);return o.checkSupport=function(){var e=a.browserInfo.browser,t=parseInt(a.browserInfo.browserVersion.split(".")[0],10),i="Your browser: "+e,n="Your browser ("+e+" - version "+t+") is not fully supported. Please use newest Chrome, Firefox or Opera.",r="Your browser ("+e+" - version "+t+") is not supported. Please use newest Chrome, Firefox or Opera.",s=1;switch(c(i),e){case"Chrome":s=1,t<55&&(s=2,t<50&&(s=3));break;case"Firefox":s=1,t<50&&(s=2,t<42&&(s=3));break;case"Opera":s=1,t<42&&(s=2,t<40&&(s=3));break;case"Microsoft Edge":s=3;break;default:s=0}return 0===s?h(r):s>1&&u(n),s},f._listenToMediaController=function(e){e.on("StreamActive",this._onStreamActive.bind(this)),e.on("StreamInactive",this._onStreamInactive.bind(this)),e.on("StreamTrackEnded",this._onStreamTrackEnded.bind(this)),e.on("StreamAddTrack",this._onStreamAddTrack.bind(this)),e.on("StreamRemoveTrack",this._onStreamRemoveTrack.bind(this))},f._listenToChannelMember=function(e){e.getRole()!==r.ROLE_BROADCASTER&&(e.on("PeerListUpdated",this._onPeerlistUpdated.bind(this)),e.on("PeerEntryUpdated",this._onPeerEntryUpdated.bind(this))),e.on("SignInSuccess",this._onSignInSuccess.bind(this)),e.on("SignInError",this._onSignInError.bind(this)),e.on("SignOutSuccess",this._onSignOutSuccess.bind(this)),e.on("SignOutError",this._onSignOutError.bind(this)),e.on("Handshake",this._onHandshake.bind(this)),e.on("CallIncoming",this._onCallIncoming.bind(this)),e.on("CallRejected",this._onCallRejected.bind(this)),e.on("RemotePeerDisconnected",this._onRemotePeerDisconnected.bind(this)),e.on("RemoteStreamAdded",this._onRemoteStreamAdded.bind(this)),e.on("GetBusy",this._onGetBusy.bind(this)),e.on("SignalingStateChanged",this._onSignalingStateChanged.bind(this)),e.on("HangingGetError",this._onHangingGetError.bind(this)),e.on("HangingGetServerStatus",this._onHangingGetServerStatus.bind(this)),e.on("CallActive",this._onCallActive.bind(this)),e.on("ReceivedWebRTCStats",this._onReceivedWebRTCStats.bind(this)),e.on("CallAgainStable",this._onCallAgainStable.bind(this)),e.on("CallUnstable",this._onCallUnstable.bind(this)),e.on("CallDropped",this._onCallDropped.bind(this)),e.on("CallHandshakeWon",this._onCallHandshakeWon.bind(this)),e.on("CallState",this._onCallState.bind(this))},f._onSignInSuccess=function(e){if(this._channels.add(e.target),e.target.getRole()===r.ROLE_CHATTER&&1===this._channels.getChatters().length&&(e.name="EnterRoomSuccess",this._isSignedIn=!0),e.target.getRole()!==r.ROLE_BROADCASTER&&!this._channels.getFreeChatter()){var t=this;setTimeout(function(){t._signInChannelMember(r.ROLE_CHATTER)},0)}this._streamInUse(),this.emit(e.name,e)},f._onSignInError=function(e){e.target.getRole()===r.ROLE_CHATTER&&0===this._channels.getChatters().length?e.name="EnterRoomError":e.target.getRole()===r.ROLE_BROADCASTER&&(e.name="StartBroadcastError"),this._streamInUse(),this.emit(e.name,e)},f._onSignOutSuccess=function(e){if(this._channels.remove(e.target),e.target.getRole()===r.ROLE_CHATTER&&0===this._channels.getChatters().length?(e.name="LeaveRoomSuccess",this._isSignedIn=!1):e.target.getRole()===r.ROLE_BROADCASTER&&(e.name="StopBroadcastSuccess",this._isBroadcasting=!1),e.target.getRole()!==r.ROLE_BROADCASTER&&0!==this._channels.getChatters().length&&!this._channels.getFreeChatter()){var t=this;setTimeout(function(){t._signInChannelMember(r.ROLE_CHATTER)},0)}this._streamInUse(),this.emit(e.name,e)},f._onSignOutError=function(e){e.target.getState()===r.CHANNEL_IDLE&&0===this._channels.getChatters().length?e.name="LeaveRoomError":e.target.getRole()===r.ROLE_BROADCASTER&&(e.name="StopBroadcastError"),this._streamInUse(),this.emit(e.name,e)},f._emitPeerListUpdated=function(){this.emitSimple("PeerListUpdated",{userlist:this._userList.createPublicUserList()})},f._onPeerlistUpdated=function(e){var t,i,n,a,s=e.data.userlist,o={};for(n=0,a=s.length;n<a;n++)i=s[n].name.split("_"),t=i[0],this._userId!==t&&(o[t]||(o[t]=[i[1]]),o[t].push(s[n].id));var d,c;for(t in o)for(c=o[t],c.unshift(r.CHANNEL_SIGNED_IN),n=2,a=c.length;n<a;n++)if(d=this._channels.findByRemoteId(c[n])){c[0]=d.getState();break}this._userList._list=o,e.data.userlist=this._userList.createPublicUserList(),this.emit(e.name,e)},f._onHandshake=function(e){this._userList.updateEntryState(e.target)&&this._emitPeerListUpdated()},f._onPeerEntryUpdated=function(e){this._userList.updateEntry(e),this._emitPeerListUpdated()},f._onRemotePeerDisconnected=function(e){c("CM "+e.target.getPeerId()+": Remote peer "+e.target.getRemotePeerId()+" disconnected");var t;(t=e.target.getRole()===r.ROLE_BROADCASTER)?(this._isBroadcasting?(e.name="BroadcastError",e.data.text="The broadcast server is disconnected!"):(e.name="StartBroadcastError",e.data.text="The broadcast server is disconnected!"),this._isBroadcasting=!1):e.target.getState()===r.CHANNEL_CALLING?e.name="CallDeclined":e.target.getState()>r.CHANNEL_SIGNED_IN&&e.target.getState()!==r.CHANNEL_CALL_ACTIVE&&(e.name="CallRejected"),t?this._channels.signOutBroadcaster():this._signOutChannelMember(e.data.remoteUserId),this.emit(e.name,e)},f._onGetBusy=function(e){if(e.target.getRole()!==r.ROLE_BROADCASTER){this._userList.updateEntryState(e.target)&&this._emitPeerListUpdated(),c("CM "+e.target.getPeerId()+"is gone busy");var t=this;setTimeout(function(){t._signInChannelMember(r.ROLE_CHATTER)},0)}},f._onCallIncoming=function(e){if(e.target.getRole()===r.ROLE_BROADCASTER){var t=e.target;t&&(this._attachStreamToChannelMember(t,this._mediaController.getLocalMediaStream()),t.answerCall())}else this._userList.updateEntryState(e.target)&&this._emitPeerListUpdated(),this.emit(e.name,e)},f._onCallRejected=function(e){if(e.target.getRole()===r.ROLE_BROADCASTER)return void c("Some on calls us, but we are a broadcaster!");var t=e.data.remoteUserName;e.data.remoteUserId;c("Call with "+t+" rejected! Try again!"),this._userList.updateEntryState(e.target)&&this._emitPeerListUpdated(),this.emit(e.name,e)},f._onRemoteStreamAdded=function(e){if(e.target.getRole()!==r.ROLE_BROADCASTER){e.data.stream&&"default"===e.data.stream.id;var t=this;this._mediaController.addRemoteMedia(e.target.getRemoteUserName(),this._mediaController.getRemoteMedias().length),this._mediaController.getRemoteMediaById(e.target.getRemoteUserName()).addMediaStream(e.data.stream,function(i){for(var n in i.data)e.data.hasOwnProperty(n)||(e.data[n]=i.data[n]);t.emit(e.name,e)},function(i){for(var n in i.data)e.data.hasOwnProperty(n)||(e.data[n]=i.data[n]);e.name="RemoteStreamError",t.emit(e.name,e)})}},f._onSignalingStateChanged=function(e){this.emit(e.name,e)},f._onHangingGetError=function(e){c("Server or Network down, close all calls, broadcasts and leave room!"),this._mediaController.removeRemoteMedia(),this._channels.signOutChatters(1),this._channels.signOutBroadcaster(1),this._streamInUse(),e.name="ServerError",this.emit(e.name,e),e.name="LeaveRoomSuccess",this.emit(e.name,e),e.name="StopBroadcastSuccess",this.emit(e.name,e)},f._onHangingGetServerStatus=function(e){e.name="ServerStatus",this.emit(e.name,e)},f._onCallActive=function(e){e.target.getRole()===r.ROLE_BROADCASTER?this._isBroadcasting||(e.name="StartBroadcastSuccess",this._isBroadcasting=!0,this.emit(e.name,e)):(this._userList.updateEntryState(e.target)&&this._emitPeerListUpdated(),this.emit(e.name,e))},f._onReceivedRtmpStatus=function(e){if(e.target.getRole()!==r.ROLE_BROADCASTER)return void u("Warning: Received rtmp status from channelmember "+e.target.getPeerId()+" with role "+e.target.getRole()+", return");switch(e.data.status){case"status":switch(e.data.text){case"connected":e.name="BroadcastStatus",this.emit(e.name,e);break;case"reconnecting":e.name="BroadcastStatus",this.emit(e.name,e)}break;case"error":switch(e.data.number){case 4711:this._isBroadcasting?e.name="StartBroadcastError":e.name="BroadcastError",this._isBroadcasting=!1,this._channels.signOutBroadcaster(),this.emit(e.name,e)}e.name="BroadcastStatus",this.emit(e.name,e)}},f._onReceivedWebRTCStats=function(e){this.emit(e.name,e)},f._onCallUnstable=function(e){e.target.getRole()!==r.ROLE_BROADCASTER&&(this._userList.updateEntryState(e.target)&&this._emitPeerListUpdated(),this.emit(e.name,e))},f._onCallDropped=function(e){e.target.getRole()===r.ROLE_BROADCASTER?(this._isBroadcasting?(e.name="BroadcastError",e.data.text="The broadcast connection has dropped! Stopping!"):(e.name="StartBroadcastError",e.data.text="The broadcast connection has dropped!"),this._channels.signOutBroadcaster()):this._userList.updateEntryState(e.target)&&this._emitPeerListUpdated(),this.emit(e.name,e)},f._onCallAgainStable=function(e){e.target.getRole()!==r.ROLE_BROADCASTER&&(this._userList.updateEntryState(e.target)&&this._emitPeerListUpdated(),this.emit(e.name,e))},f._onCallHandshakeWon=function(e){var t=e.data.remoteUserName,i=e.data.remoteUserId,n=e.data.remotePeerId;c("We ("+e.target.getPeerId()+') won the handshake, now calling "'+t+" "+i+" with peer "+n),this._doCall(e.target)},f._onCallState=function(e){e.target.getRole()!==r.ROLE_BROADCASTER&&this._userList.updateEntryState(e.target)&&this._emitPeerListUpdated()},f._onStreamActive=function(e){c("MediaStream Event: "+e.type)},f._onStreamInactive=function(e){c("MediaStream Event: "+e.type)},f._onStreamTrackEnded=function(e){c("MediaStream Event: "+e.target.kind+" track "+e.type+' from device "'+e.target.label+'"'),e.name="MediaStreamError",e.data.error=e.target.kind+" track "+e.type+' from device "'+e.target.label+'", maybe in use or device stopped working',this.emit(e.name,e)},f._onStreamAddTrack=function(e){c("MediaStream Event: "+e.type)},f._onStreamRemoveTrack=function(e){c("MediaStream Event: "+e.type)},f._attachStreamToChannelMember=function(e,t){e.addStream(t)},f._signInChannelMember=function(e){var t=new n(this._server,this._userName,this._userId,this._room,e,this._token,this._serverUserName,this._serverPassword,this._bintuApiKey);t.setConfig(this._optionalConfig),t.setIceServers(this._iceServers),t.enableStats(this._statsEnabled),this._listenToChannelMember(t),t.signIn()},f._signOutChannelMember=function(e){var t=this._channels.findByRemoteUserId(e);t&&(c("Sign out channelmember "+t.getPeerId()),this._mediaController.removeRemoteMedia(t.getRemoteUserName()),t.signOut(),this._userList.updateEntryState(t)&&this._emitPeerListUpdated())},f._streamInUse=function(){var e=this._channels.getChatters().length>1||!!this._channels.getBroadcaster();this._streamProtected=e,this.emitSimple("StreamInUse",{streaminuse:this._streamProtected,onlybroadcast:!!this._channels.getBroadcaster()&&this._channels.getChatters().length<2,onlychat:!this._channels.getBroadcaster()&&this._channels.getChatters().length>1})},f._getDevicesSuccess=function(e){this.emitSimple("ReceivedDeviceList",e.data)},f._getDevicesError=function(e){var t=e.data.error.message||e.data.error.toString();h(t)},f.addLocalMedia=function(e,t,i,n){this._mediaController.addLocalMedia(e,t,i,n)},f.setConfig=function(e,t,i,n,r,a,s){this._server=e,this._userName=t,this._room=i,this._token=n,this._serverUserName=r,this._serverPassword=a,this._bintuApiKey=s},f.setOptionalConfig=function(e){if("undefined"!=typeof e)for(var t in e)if(this._optionalConfig.hasOwnProperty(t))if(e[t]instanceof Object){var i=e[t];for(var n in i)this._optionalConfig[t].hasOwnProperty(n)&&(this._optionalConfig[t][n]=i[n])}else this._optionalConfig[t]=e[t]},f.setIceServers=function(e){this._iceServers=e},f.checkServer=function(e){function t(){200===this.status&&n.emitSimple("ReceivedServerStats",{stats:l(this.responseText)||{error:{message:"Could not parse response from server",code:-1,userinfo:null}}})}function i(){console.log("error checking server.")}var n=this,r=new XMLHttpRequest;r.withCredentials=!0,r.onload=t,r.onerror=i;var a=e||this._server;a&&(r.open("GET",a+"/status.json"),r.send())},f.startBroadcast=function(e){var t=new n(this._server,this._userName,this._userId,this._room,r.ROLE_BROADCASTER,this._token,this._serverUserName,this._serverPassword,this._bintuApiKey);t.setConfig(this._optionalConfig),t.setIceServers(this._iceServers),t.enableStats(this._statsEnabled,this._statsIntervalTime),this._listenToChannelMember(t);var i=this._mediaController.getLocalMediaStream(),a=this._mediaController.getLocalMediaMetaData(i.id);e.transcodingTargets.videowidth=a[0].width,e.transcodingTargets.videoheight=a[0].height,t.setTranscodingSettings(e.transcodingTargets),this._attachStreamToChannelMember(t,i),t.on("ReceivedRtmpStatus",this._onReceivedRtmpStatus.bind(this)),t.signIn()},f.stopBroadcast=function(e){this._isBroadcasting?this._channels.signOutBroadcaster(e):u("no broadcast active")},f.sendMetaData=function(e,t){if(!p(e))return void h("Param handlerName must be of string type, not sending metadata.");if(!m(t))return void h("Param metaData must be of object type, not sending metadata.");if(this._isBroadcasting){var i=this._channels.getBroadcaster();i.sendMetaData(e,t)}else u("no broadcast active, not sending metadata.")},f.enterRoom=function(){this._signInChannelMember(r.ROLE_CHATTER)},f.leaveRoom=function(e){if(this._mediaController.removeRemoteMedia(),0===this._channels.getChatters().length){var t={};return t.name="LeaveRoomSuccess",void this.emit(t.name,t)}this._channels.signOutChatters(e),this._isSignedIn=!1},f.enableStats=function(e,t){this._statsEnabled="undefined"==typeof e||e,this._statsIntervalTime=t||1e3},f.invokeCall=function(e){var t,i=this._userList.getUserStateByRemoteUserId(e);if(i>r.CHANNEL_SIGNED_IN)t=this._userList.getUserNameByRemoteUserId(e),this.emitSimple("CallStillActive",{remoteUserName:t,remoteUserId:e});else{var n=this._channels.getFreeChatter(),a=this._userList.getFreePeerIdByRemoteUserId(e);n&&n.invokeCall(a)}},f._doCall=function(e){var t,i=e.getRemoteUserId(),n=this._userList.getUserStateByRemoteUserId(i);n>r.CHANNEL_HANDSHAKE?(t=this._userList.getUserNameByRemoteUserId(i),this.emitSimple("CallStillActive",{remoteUserName:t,remoteUserId:i})):(this._attachStreamToChannelMember(e,this._mediaController.getLocalMediaStream()),e.doCall())},f.hangUpCall=function(e){this._signOutChannelMember(e)},f.answerCall=function(e){var t=this._channels.findByRemoteUserId(e);this._attachStreamToChannelMember(t,this._mediaController.getLocalMediaStream()),t&&t.answerCall()},f.declineCall=function(e){this._signOutChannelMember(e)},f.isSignedIn=function(){return this._isSignedIn},f.getDevices=function(e){this._mediaController.getDevices(e,this._getDevicesSuccess.bind(this),this._getDevicesError.bind(this))},f.setVideoDevice=function(e,t){this._streamProtected||this._mediaController.setVideoDevice(e,t)},f.setAudioDevice=function(e,t){this._streamProtected||this._mediaController.setAudioDevice(e,t)},f._getStream=function(e,t){this._mediaController.getUserMedia(e,function(e){t(e,void 0)},function(e){t(void 0,e)})},f._stopStream=function(e,t){this._mediaController.deleteUserMedia(e,function(e){t(e,void 0)},function(e){t(void 0,e)})},f.startPreview=function(e,t,i,n){if(!this._streamProtected){this.setVideoDevice(e,t),this.setAudioDevice(e,i);var r=this;this._getStream(e,function(e,t){if(e&&e.data&&e.data.stream){r._listenToMediaController(r._mediaController);var i=e.data.stream;n&&(d(n).srcObject=i),e.name="StartPreviewSuccess",r.emit(e.name,e)}else{var e=t;if(e.data=e.data||{},e.name="StartPreviewError",t.data.error&&t.data.error.name){var a,s=t.data.error;s.message&&(a=s.message),"NotFoundError"===s.name&&(a="No device found, please attach a media device."),e.data.error=s.name,e.data.error+=s.code?" (code "+s.code+")":"",e.data.error+=a?": "+a:"",e.data.error+=s.constraintName?' in constraint "'+s.constraintName+'"':""}r.emit(e.name,e)}})}},f.stopPreview=function(e){if(!this._streamProtected){var t=this;this._stopStream(e,function(e,i){var n=e;null===n.data.stream?n.name="StopPreviewSuccess":(n=i||{},n.data=n.data||{},n.name="StopPreviewError",n.data.error=n.data.error?n.data.error:"unknown error"),t.emit(n.name,n)})}},f.muteVideo=function(e,t){this._mediaController.muteVideoTracks(e,t)},f.muteAudio=function(e,t){this._mediaController.muteAudioTracks(e,t)},o}),define("nano.audioprocess",["EventEmitter","nano.tools"],function(e,t){function i(){e.call(this),this._bufferSize=1024,this._numInputChannels=2,this._numOutputChannels=2,this._channels=[],this._microphone=null,this._scriptProcessorNode=null,this.active=!1;var t=window.AudioContext||window.webkitAudioContext;d(t)?this._audioContext=new t:(s("no browser audio context found"),this._audioContext=null)}function n(e,t){e=e||{},o(t)||s("AudioChannel: param audioProcess must be of type object",2),this._audioProcess=t,this._level=0,this._maxLevel=0,this._oldLevel=0,this._id=e.id,this._name=e.name,this._channelData=void 0}var r=Math.max,a=Math.sqrt,s=(t.warning_,t.error_),o=t.isObject,d=t.isFunction,c=i.prototype=Object.create(e.prototype);return c.connect=function(e,t){t=t||{channels:[]},this._bufferSize=t.bufferSize||1024,this._numInputChannels=t.numInputChannels||2,this._numOutputChannels=t.numOutputChannels||2,this._channels=[];for(var i=0,r=t.channels.length;i<r;i++)this._channels.push(new n(t.channels[i],this));if(!e)return void this.emitSimple("AudioNoStream",{stream:e});var a=e.getAudioTracks();if(a&&a.length>0){var s=this._scriptProcessorNode=this._audioContext.createScriptProcessor(this._bufferSize,this._numInputChannels,this._numOutputChannels);this._microphone=this._audioContext.createMediaStreamSource(e),this._microphone.connect(s),s.connect(this._audioContext.destination),s.onaudioprocess=this._onAudioProcess.bind(this),this.active=!0}else this.emitSimple("AudioNoTrack",{stream:e})},c.reset=function(){this.active=!1,this._microphone=null,this._scriptProcessorNode=null},c._onAudioProcess=function(e){if(this.active){var t=e.inputBuffer,i=this._channels,n=this;setTimeout(function(){for(var e=[],r=0,a=i.length;r<a;r++)i[r].update(t.getChannelData(r)),e.push(i[r].getChannelData());n.emitSimple("AudioProcess",{channels:e})},0)}},n.prototype.update=function(e){this._channelData=e;for(var t=0,i=e.length,n=0;n<i;n++)t+=e[n]*e[n];this._level=a(t/(i?i:1)),this._maxLevel=r(this._level,this._maxLevel),this._oldLevel=r(this._level,this._oldLevel-.008)},n.prototype.getChannelData=function(){return{maxLevel:this._maxLevel,oldLevel:this._oldLevel,avgLevel:this._level,name:this._name,id:this._id}},i}),function(){"use strict";var e={webrtc:{release_version:"4.5.3.1",release_description:"main"}};"undefined"!=typeof module?module.exports=function(t){return e}:define("nano.versioninfo",[],function(){return JSON.parse(JSON.stringify(e))})}(),requirejs.config({baseUrl:"js/api/webrtc",paths:{},waitSeconds:20}),define("nano.webrtc.require",["nano.rtcuser","nano.const","nano.tools","nano.audioprocess","nano.versioninfo"],function(e,t,i,n,r){var a,s=i.getHTTPParam("debug");i.debugLevel=s&&(a=parseInt(s))?a:0,window.nanowebrtc={user:e,tools:i,const:t,audioprocess:n,version:r.webrtc.release_version,release_description:r.webrtc.release_description}}),requirejs.onError=function(e){var t="unknown error";switch(e.requireType){case"scripterror":t="One or more module(s) missing!";break;case"nodefine":t="One or more module(s) dont use the define directive!";break;case"timeout":t="Timeout when loading one or more module(s)! You may try to reload the page!"}t=t+"\n\r - Original error: "+e,console.error(t),e.stack&&console.error(e.stack)};